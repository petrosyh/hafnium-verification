<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>FFAMemoryHypCallTestingInterface</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library FFAMemoryHypCallTestingInterface</h1>

<div class="code">

<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">Z_64MAX</span> := ((<span class="id" title="var">Z.pow</span> 2 64) - 1)%<span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">Z_not</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">val</span> =&gt; (<span class="id" title="var">Z.lxor</span> <span class="id" title="var">Z_64MAX</span> <span class="id" title="var">val</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab150"></a><h1 class="section">Introduction</h1>

<div class="paragraph"> </div>

 This file contains definitions that are necessary for providing testing interfaces. 
    They are usually contains Z type (or integer type) values that are relevant to several 
    inductive type values in other files. 

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Notation</span> &quot;'get' E ',' X &lt;- A ';;;' B" :=<br/>
&nbsp;&nbsp;(<span class="id" title="keyword">match</span> <span class="id" title="var">A</span> <span class="id" title="keyword">with</span> <span class="id" title="var">Some</span> <span class="id" title="var">X</span> =&gt; <span class="id" title="var">B</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">None</span> =&gt; <span class="id" title="var">triggerNB</span> <span class="id" title="var">E</span> <span class="id" title="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 200, <span class="id" title="var">X</span> <span class="id" title="var">ident</span>, <span class="id" title="var">A</span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 100, <span class="id" title="var">B</span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id" title="var">itree_monad_scope</span>.<br/>

<br/>
<span class="id" title="keyword">Notation</span> &quot;'get' X &lt;- A ';;;' B" :=<br/>
&nbsp;&nbsp;(<span class="id" title="keyword">match</span> <span class="id" title="var">A</span> <span class="id" title="keyword">with</span> <span class="id" title="var">Some</span> <span class="id" title="var">X</span> =&gt; <span class="id" title="var">B</span> |<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">None</span> =&gt; <span class="id" title="var">triggerNB</span> "None" <span class="id" title="keyword">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 200, <span class="id" title="var">X</span> <span class="id" title="var">ident</span>, <span class="id" title="var">A</span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 100, <span class="id" title="var">B</span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id" title="var">itree_monad_scope</span>.<br/>

<br/>
<span class="id" title="keyword">Notation</span> &quot;'check' E ',' A ';;;' B" :=<br/>
&nbsp;&nbsp;(<span class="id" title="keyword">if</span> <span class="id" title="var">A</span> <span class="id" title="keyword">then</span> <span class="id" title="var">B</span> <span class="id" title="keyword">else</span> <span class="id" title="var">triggerNB</span> <span class="id" title="var">E</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 200, <span class="id" title="var">A</span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 100, <span class="id" title="var">B</span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 200)<br/>
&nbsp;&nbsp;: <span class="id" title="var">itree_monad_scope</span>.<br/>

<br/>
<span class="id" title="keyword">Local Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">itree_monad_scope</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab151"></a><h1 class="section">Instantiations for contexts</h1>
 We provides instantiations for the context that our specifiction
    relies on. 
<div class="paragraph"> </div>

<a name="lab152"></a><h2 class="section">FFA_TYPES_AND_CONSTANTS instance</h2>

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">ffa_memory_region_tag_t</span> := <span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">granuale_shift</span> := 12.<br/>

<br/>
<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">ffa_types_and_constants</span> : <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span> :=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id" title="var">ffa_memory_region_tag_t</span> := <span class="id" title="var">ffa_memory_region_tag_t</span>;<br/>
&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> The following two types are for message passings. We use them to record and 
        retrieve descriptor information 
</li>
</ul>

<div class="paragraph"> </div>

<ul class="doclist">
<li> Granuale value. It is usually a multiplication of 4096 (4KiB) 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">granuale</span> := <span class="id" title="var">Z.shiftl</span> 1 <span class="id" title="var">granuale_shift</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">init_ffa_memory_region_tag</span> := 0;<br/>
&nbsp;&nbsp;}.<br/>

<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> <span class="id" title="var">granuale</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab153"></a><h2 class="section">DescriptorContext instance</h2>

</div>
<div class="code">
<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">descriptor_context</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">DescriptorContext</span> (<span class="id" title="var">ffa_types_and_constants</span> := <span class="id" title="var">ffa_types_and_constants</span>) :=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id" title="var">make_handle</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">vid</span> <span class="id" title="var">value</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (0 &lt;= <span class="id" title="var">vid</span> &lt; (<span class="id" title="var">Z.shiftl</span> 1 16))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (0 &lt;= <span class="id" title="var">value</span> &lt; (<span class="id" title="var">Z.shiftl</span> 1 16))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">Z.lor</span> (<span class="id" title="var">Z.shiftl</span> <span class="id" title="var">vid</span> 16) <span class="id" title="var">value</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">get_value</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">handle</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">mask</span> := ((<span class="id" title="var">Z.shiftl</span> 1 16) - 1)%<span class="id" title="var">Z</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Z.land</span> <span class="id" title="var">mask</span> <span class="id" title="var">handle</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">get_sender</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">handle</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Z.shiftr</span> <span class="id" title="var">handle</span> 16;<br/>
&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab154"></a><h2 class="section">FFA_VM_CONTEXT instance</h2>
 buffer message could be either the initial value, memory region descriptor, relinquish descriptor,
    or handle value (Z type value). 
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">ffa_buffer_msg_instance_t</span> : <span class="id" title="keyword">Type</span> :=<br/>
| <span class="id" title="var">buffer_memory_init_value</span><br/>
| <span class="id" title="var">buffer_memory_region</span> (<span class="id" title="var">region_descriptor</span>: <span class="id" title="var">FFA_memory_region_struct</span>)<br/>
| <span class="id" title="var">buffer_memory_relinquish</span> (<span class="id" title="var">relinquish_descriptor</span>: <span class="id" title="var">FFA_memory_relinquish_struct</span>)<br/>
| <span class="id" title="var">buffer_z</span> (<span class="id" title="var">value</span> : <span class="id" title="var">Z</span>).<br/>

<br/>
</div>

<div class="doc">
We assume there are four VCPUs in the system 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_ffa_buffer_msg</span> := <span class="id" title="var">buffer_memory_init_value</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">vcpu_max_num</span> := 4.<br/>

<br/>
</div>

<div class="doc">
Conversions to/from mailbox messages from/to memory region descriptor/relinquish descriptor/handle value 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">buffer_msg_to_region_struct</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">x</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">buffer_memory_region</span> <span class="id" title="var">region_descriptor</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> <span class="id" title="var">region_descriptor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">buffer_msg_to_relinquish_struct</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">x</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">buffer_memory_relinquish</span> <span class="id" title="var">relinquish_descriptor</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> <span class="id" title="var">relinquish_descriptor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">buffer_msg_to_z</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">x</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">buffer_z</span> <span class="id" title="var">value</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Some</span> <span class="id" title="var">value</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">region_struct_to_buffer_msg</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">buffer_memory_region</span> <span class="id" title="var">x</span>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">relinquish_struct_to_buffer_msg</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">buffer_memory_relinquish</span> <span class="id" title="var">x</span>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">z_to_buffer_msg</span> := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">buffer_z</span> <span class="id" title="var">x</span>).<br/>

<br/>
<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">ffa_vm_context</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">FFA_VM_CONTEXT</span> (<span class="id" title="var">ffa_types_and_constants</span> := <span class="id" title="var">ffa_types_and_constants</span>)  :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> The following two types are for message passings. We use them to record and 
        retrieve descriptor information 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_buffer_msg_t</span> := <span class="id" title="var">ffa_buffer_msg_instance_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_ffa_buffer_msg</span> := <span class="id" title="var">init_ffa_buffer_msg</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_max_num</span> := <span class="id" title="var">vcpu_max_num</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
mailbox to/from descriptors 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">buffer_msg_to_region_struct</span> := <span class="id" title="var">buffer_msg_to_region_struct</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">buffer_msg_to_relinqiush_struct</span> := <span class="id" title="var">buffer_msg_to_relinquish_struct</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">buffer_msg_to_Z</span> := <span class="id" title="var">buffer_msg_to_z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">region_struct_to_buffer_msg</span> := <span class="id" title="var">region_struct_to_buffer_msg</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">relinqiush_struct_to_buffer_msg</span> := <span class="id" title="var">relinquish_struct_to_buffer_msg</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Z_to_buffer_msg</span> := <span class="id" title="var">z_to_buffer_msg</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">primary_vm_id</span> := 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">secondary_vm_ids</span> := 2::3::4::<span class="id" title="var">nil</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_size</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> =&gt; 1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
TODO: The following values are dummy representations. We have to provide 
    proper values later if we want to connect this one with the real Hafnium / other 
    hypervisor implementations 
<div class="paragraph"> </div>

<a name="lab155"></a><h2 class="section">HafniumMemoryManagementContext instance</h2>
 Note that we cannot use a large number in here to avoid stack overflow. 
    I have tested with 16, but it raised stack overflow. 

<div class="paragraph"> </div>

    With the current instance, the memory address range that we can represent 
    is from (0 * 2^12) to (2^12 * 2^12) since the granuale is 2^12.
 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">page_high_shift</span> := 12.<br/>

<br/>
<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">memory_management_basic_context</span><br/>
&nbsp;&nbsp;: <span class="id" title="var">MemoryManagementBasicContext</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_vm_context</span> := <span class="id" title="var">ffa_vm_context</span>) :=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id" title="var">page_low</span> := 0;<br/>
&nbsp;&nbsp;<span class="id" title="var">page_high</span> := (<span class="id" title="var">Z.shiftl</span> 1 <span class="id" title="var">page_high_shift</span>)%<span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">alignment_value</span> := <span class="id" title="var">granuale</span>;<br/>
&nbsp;&nbsp;}.<br/>

<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> (<span class="id" title="var">page_low</span> * <span class="id" title="var">granuale</span>)%<span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="tactic">in</span> (<span class="id" title="var">page_high</span> * <span class="id" title="var">granuale</span>)%<span class="id" title="var">Z</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">stage2_address_translation_table</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> (<span class="id" title="var">x</span> : <span class="id" title="var">ffa_address_t</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> ((<span class="id" title="var">page_low</span> * <span class="id" title="var">granuale</span>) &lt;= <span class="id" title="var">x</span>)%<span class="id" title="var">Z</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">x</span> &lt; (<span class="id" title="var">page_high</span> * <span class="id" title="var">granuale</span>))%<span class="id" title="var">Z</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">x</span> <span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span>  <span class="id" title="var">stage1_address_translation_table</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> (<span class="id" title="var">vid</span> : <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">x</span> : <span class="id" title="var">ffa_address_t</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">address_low</span> := (<span class="id" title="var">page_low</span> * <span class="id" title="var">granuale</span>)%<span class="id" title="var">Z</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">address_high</span> := (<span class="id" title="var">page_high</span> * <span class="id" title="var">granuale</span>)%<span class="id" title="var">Z</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (0 &lt;= <span class="id" title="var">vid</span>)%<span class="id" title="var">Z</span> &amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">vid</span> &lt; <span class="id" title="var">number_of_vm</span>)%<span class="id" title="var">Z</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">address_low</span> &lt;= <span class="id" title="var">x</span>)%<span class="id" title="var">Z</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decide</span> (<span class="id" title="var">x</span> &lt; <span class="id" title="var">address_high</span>)%<span class="id" title="var">Z</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">memory_management_context</span><br/>
&nbsp;&nbsp;: <span class="id" title="var">MemoryManagementContext</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">memory_management_basic_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="var">memory_management_basic_context</span>) :=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;<span class="id" title="var">stage2_address_translation_table</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">stage2_address_translation_table</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">stage1_address_translation_table</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">stage1_address_translation_table</span>;<br/>
&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab156"></a><h2 class="section">AbstractStateContext instance</h2>

<div class="paragraph"> </div>

 We assume number of CPUs as 4 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_cpu_id</span> := 0.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">num_of_cpus</span> := 4.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_CPU_struct</span> := <span class="id" title="var">mkCPU_struct</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">cal_init_cpus</span> (<span class="id" title="var">cpu_nums</span> : <span class="id" title="var">nat</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">cpu_nums</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">O</span> =&gt;  (<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">CPU_struct</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">S</span> <span class="id" title="var">n'</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">res</span> :=  <span class="id" title="var">cal_init_cpus</span> <span class="id" title="var">n'</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> (<span class="id" title="var">Z.of_nat</span> <span class="id" title="var">cpu_nums</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_CPU_struct</span> <span class="id" title="var">res</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_cpus</span> := <span class="id" title="var">cal_init_cpus</span> (<span class="id" title="var">Z.to_nat</span> (<span class="id" title="var">num_of_cpus</span> - 1)).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_api_page_pool_size_shift</span> := 32.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_mem_global_properties</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">mkMemGlobalProperties</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">NotOwned</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">NoAccess</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_INSTRUCTION_ACCESS_NOT_SPECIFIED</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_DATA_ACCESS_NOT_SPECIFIED</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_NOT_SPECIFIED_MEM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">MemClean</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">cal_init_global_properties_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">address</span> : <span class="id" title="var">nat</span>)  :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">address</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" title="var">O</span> =&gt; <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (0 &gt;= <span class="id" title="var">page_low</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">ZTree.set</span> (<span class="id" title="var">Z.shiftl</span> 0 <span class="id" title="var">granuale_shift</span>)  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_mem_global_properties</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">MemGlobalProperties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">MemGlobalProperties</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">S</span> <span class="id" title="var">n'</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">converted_addr</span> := <span class="id" title="var">Z.shiftl</span> (<span class="id" title="var">Z.of_nat</span> <span class="id" title="var">address</span>) <span class="id" title="var">granuale_shift</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">converted_addr</span> &gt;= <span class="id" title="var">page_low</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">let</span> <span class="id" title="var">res</span> := <span class="id" title="var">cal_init_global_properties_pool</span> <span class="id" title="var">n'</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">converted_addr</span>  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_mem_global_properties</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">MemGlobalProperties</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_mem_global_properties_pool</span><br/>
&nbsp;&nbsp;: <span class="id" title="var">mem_global_properties_pool</span><br/>
&nbsp;&nbsp;:= <span class="id" title="var">cal_init_global_properties_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Z.to_nat</span> <span class="id" title="var">page_high</span>).<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">cal_init_local_properties_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vms</span> : <span class="id" title="var">list</span> <span class="id" title="var">Z</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">vms</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; (<span class="id" title="var">ZTree.empty</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.t</span> <span class="id" title="var">MemLocalProperties</span>))<br/>
&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">res</span> := <span class="id" title="var">cal_init_local_properties_pool</span> <span class="id" title="var">tl</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">hd</span> (<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">MemLocalProperties</span>) <span class="id" title="var">res</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_mem_local_properties_global_pool</span> <br/>
&nbsp;&nbsp;: <span class="id" title="var">mem_local_properties_global_pool</span><br/>
&nbsp;&nbsp;:= <span class="id" title="var">cal_init_local_properties_pool</span> <span class="id" title="var">vm_ids</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_mem_properties</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">mkMemProperties</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_mem_global_properties_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_mem_local_properties_global_pool</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_VM_COMMON_struct</span> (<span class="id" title="var">vcpu_index</span> : <span class="id" title="var">Z</span>) (<span class="id" title="var">vcpu_ids</span>: <span class="id" title="var">list</span> <span class="id" title="var">Z</span>) <br/>
&nbsp;&nbsp;:= <span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">vcpu_index</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_ids</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">VCPU_struct</span>).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_BUFFER_struct</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">mkBUFFER_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_ffa_buffer_msg</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">None</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;0 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">None</span> <br/>
.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_VM_KERNEL_context</span> (<span class="id" title="var">vcpu_index</span> : <span class="id" title="var">Z</span>) (<span class="id" title="var">vcpu_ids</span>: <span class="id" title="var">list</span> <span class="id" title="var">Z</span>) :=<br/>
&nbsp;<span class="id" title="var">mkVM_KERNEL_struct</span> <br/>
&nbsp;&nbsp;&nbsp;(<span class="id" title="var">init_VM_COMMON_struct</span> <span class="id" title="var">vcpu_index</span> <span class="id" title="var">vcpu_ids</span>)<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_BUFFER_struct</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">cal_init_VM_KERNEL_contexts</span> (<span class="id" title="var">vm_ids</span>: <span class="id" title="var">list</span> <span class="id" title="var">Z</span>) := <br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">vm_ids</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt;  (<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">VM_KERNEL_struct</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">res</span> :=  <span class="id" title="var">cal_init_VM_KERNEL_contexts</span> <span class="id" title="var">tl</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">hd</span> (<span class="id" title="var">init_VM_KERNEL_context</span> <span class="id" title="var">hd</span> (<span class="id" title="var">hd</span>::<span class="id" title="var">nil</span>)) <span class="id" title="var">res</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_VM_KERNEL_contexts</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">cal_init_VM_KERNEL_contexts</span> <span class="id" title="var">vm_ids</span>.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">cal_init_VM_USERSPACE_contexts</span> (<span class="id" title="var">vm_ids</span>: <span class="id" title="var">list</span> <span class="id" title="var">Z</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">vm_ids</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt;  (<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">VM_USERSPACE_struct</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">res</span> :=  <span class="id" title="var">cal_init_VM_USERSPACE_contexts</span> <span class="id" title="var">tl</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">hd</span> (<span class="id" title="var">mkVM_USERSPACE_struct</span> (<span class="id" title="var">init_VM_COMMON_struct</span> <span class="id" title="var">hd</span> (<span class="id" title="var">hd</span>::<span class="id" title="var">nil</span>))) <span class="id" title="var">res</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_VM_USERSPACE_contexts</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">cal_init_VM_USERSPACE_contexts</span> <span class="id" title="var">vm_ids</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_hypervisor_struct</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">mkHypervisor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_cpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">num_of_cpus</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_cpus</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">false</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">None</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Z.shiftl</span> 1 <span class="id" title="var">init_api_page_pool_size_shift</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.empty</span> <span class="id" title="var">FFA_memory_share_state_struct</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;0 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_mem_properties</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">number_of_vm</span>  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_VM_KERNEL_contexts</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">version_number</span> := (1, 1).<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_abstract_state</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">mkAbstractState</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(1, 1) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">false</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">false</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;1 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_hypervisor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_VM_USERSPACE_contexts</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">nil</span> <br/>
.<br/>

<br/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">find_next_entity</span> (<span class="id" title="var">vm_ids</span> : <span class="id" title="var">list</span> <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">current_entity_id</span> : <span class="id" title="var">ffa_UUID_t</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">vm_ids</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">primary_vm_id</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">current_entity_id</span> = <span class="id" title="var">hd</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">match</span> <span class="id" title="var">tl</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">primary_vm_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">hd'</span>::<span class="id" title="var">_</span> =&gt; <span class="id" title="var">hd'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">find_next_entity</span> <span class="id" title="var">tl</span> <span class="id" title="var">current_entity_id</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">scheduler</span> (<span class="id" title="var">st</span>: <span class="id" title="var">AbstractState</span>) : <span class="id" title="var">ffa_UUID_t</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">cur_entity_id</span> := <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">find_next_entity</span> <span class="id" title="var">vm_ids</span> <span class="id" title="var">cur_entity_id</span>.<br/>

<br/>
<span class="id" title="keyword">Global Instance</span> <span class="id" title="var">abstract_state_context</span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">AbstractStateContext</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_types_and_constants</span> := <span class="id" title="var">ffa_types_and_constants</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor_context</span> := <span class="id" title="var">descriptor_context</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_vm_context</span> := <span class="id" title="var">ffa_vm_context</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">memory_management_basic_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="var">memory_management_basic_context</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">memory_management_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="var">memory_management_context</span>) :=<br/>
&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">scheduler</span> := <span class="id" title="var">scheduler</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">initial_state</span> := <span class="id" title="var">init_abstract_state</span>;<br/>
&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab157"></a><h1 class="section">Showable functions for system log</h1>

<div class="paragraph"> </div>

 Showable functions for system log are hidden in the document. 
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab158"></a><h1 class="section">Showable function for other abstract values</h1>

<div class="paragraph"> </div>

<a name="lab159"></a><h2 class="section">Showable function for global memory property</h2>

<div class="paragraph"> </div>

 Showable functions for global memory property are hidden in the document. 
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab160"></a><h2 class="section">Showable function for local memory property</h2>

<div class="paragraph"> </div>

 Showable functions for local memory property are hidden in the document. 
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab161"></a><h2 class="section">Showable function for vcpu structure</h2>

<div class="paragraph"> </div>

 Showable functions for vcpu struct are hidden in the document. 
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab162"></a><h1 class="section">Additional  Specifications for testing</h1>
<a name="lab163"></a><h2 class="section">Event and Update functions</h2>

</div>
<div class="code">

<br/>
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">updateStateE</span>: <span class="id" title="keyword">Type</span> -&gt; <span class="id" title="keyword">Type</span> :=<br/>
| <span class="id" title="var">GetState</span> : <span class="id" title="var">updateStateE</span> (<span class="id" title="var">AbstractState</span>)<br/>
| <span class="id" title="var">SetState</span> (<span class="id" title="var">st1</span>: <span class="id" title="var">AbstractState</span>): <span class="id" title="var">updateStateE</span> <span class="id" title="var">unit</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">updateState_handler</span> {<span class="id" title="var">E</span>: <span class="id" title="keyword">Type</span> -&gt; <span class="id" title="keyword">Type</span>}<br/>
&nbsp;&nbsp;: <span class="id" title="var">updateStateE</span> ~&gt; <span class="id" title="var">stateT</span> (<span class="id" title="var">AbstractState</span>) (<span class="id" title="var">itree</span> <span class="id" title="var">E</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">e</span> <span class="id" title="var">st</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">GetState</span> =&gt; <span class="id" title="var">Ret</span> (<span class="id" title="var">st</span>, <span class="id" title="var">st</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">SetState</span> <span class="id" title="var">st'</span> =&gt; <span class="id" title="var">Ret</span> (<span class="id" title="var">st'</span>, <span class="id" title="var">tt</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">Notation</span> <span class="id" title="var">HypervisorEE</span> := (<span class="id" title="var">CallExternalE</span> +' <span class="id" title="var">updateStateE</span> +' <span class="id" title="var">GlobalE</span> +' <span class="id" title="var">MemoryE</span> +' <span class="id" title="var">Event</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab164"></a><h2 class="section">Context switching</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFAContextSwitching</span>.<br/>

<br/>
</div>

<div class="doc">
     <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:<span class="id" title="var">We</span></span> <span class="inlinecode"><span class="id" title="var">referred</span></span> <span class="inlinecode"><span class="id" title="keyword">context</span></span> <span class="inlinecode"><span class="id" title="var">switchigns</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">Hafnium</span>,</span> <span class="inlinecode"><span class="id" title="var">but</span></span> <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="var">believe</span></span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="var">could</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">similar</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> 
     <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="var">provide</span></span> <span class="inlinecode"><span class="id" title="tactic">abstract</span></span> <span class="inlinecode"><span class="id" title="var">models</span></span> <span class="inlinecode"><span class="id" title="keyword">for</span></span> <span class="inlinecode"><span class="id" title="var">different</span></span> <span class="inlinecode"><span class="id" title="var">implementations</span></span>

<div class="paragraph"> </div>

     In Hafnium, most parts are related to save registers in "/src/arch/aarch64/hypervisor/exceptions.S"
     We dramatically simplify them by saving and restoring FFA-related register values. 
     In reality, we may need to reflect the entire register save and recovery in the file:
     "save_volatile_to_vcpu", "save_register_access", "vcpu_switch", "vcpu_restore_all_and_run",
     "vcpu_restore_lazy_and_run", "vcpu_restore_nonvolatile_and_run", and 
     "vcpu_restore_volatile_and_run" in  "/src/arch/aarch64/hypervisor/exceptions.S". 

<div class="paragraph"> </div>

     In addition to that, "handle_system_register_access" in "/src/arch/aarch64/hypervisor/handler.c"
     also a function that handles register values when handling exceptions. 

<div class="paragraph"> </div>

     How it works:
     When an exception occurs, it first checks the exception value in the register ("vector_table_el2" 
     in the file). Then, if the exception number is either "sync_lower_64" or "sync_lower_32", 
     it calls "lower_sync_exception" defined in the same file. 

<div class="paragraph"> </div>

     Then, "lower_sync_exception" performs context switching and calls a C handler function to
     service the exception.
    Save contexts 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">save_regs_to_vcpu_spec</span>  :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Extract state 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Check validities 
</li>
</ul>
<ul class="doclist">
<li> Check whether the current running entity is one of VMs 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "save_regs_to_vcpu: Wrong cur entity id" ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>) = <span class="id" title="var">false</span>) &amp;&amp; (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Extracts the VM userspace information with the given entity ID 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "save_regs_to_vcpu: cannot find vm_userspace for the entity id",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_userspace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Get the current VCPU index for the VM 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "save_regs_to_vcpu: cannot find vcpu_index information of the vm userspace",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">vm_userspace</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Copy the VCPU register information to the kernel to perform hypervisor calls 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> (<span class="id" title="var">append_all</span> ["save_regs_to_vcpu: cannot find vcpu information for ";<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HexString.of_Z</span> <span class="id" title="var">cur_vcpu_index</span>]) ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_regs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vm_userspace</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "save_regs_to_vcpu: cannot find vm context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "save_regs_to_vcpu: inconsistency between saved context and user context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">list_eq_dec</span> <span class="id" title="var">zeq</span> (<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vm_userspace</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus</span>))) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decide</span> (<span class="id" title="var">cur_vcpu_regs</span>.(<span class="id" title="var">vm_id</span>) = <span class="id" title="var">Some</span> <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Trigger transitions in the state 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_context</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span> {<span class="id" title="var">vm_cur_vcpu_index</span>: <span class="id" title="var">Some</span> <span class="id" title="var">cur_vcpu_index</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">vm_vcpus_contexts</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_vcpu_index</span> <span class="id" title="var">cur_vcpu_regs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vms_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_st</span> := <span class="id" title="var">st</span> {<span class="id" title="var">is_hvc_mode</span>: <span class="id" title="var">true</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">hypervisor_context</span>/<span class="id" title="var">tpidr_el2</span>: <span class="id" title="var">Some</span> <span class="id" title="var">cur_vcpu_regs</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">hypervisor_context</span>/<span class="id" title="var">vms_contexts</span>: <span class="id" title="var">new_vms_contexts</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">system_log</span> : <span class="id" title="var">st</span>.(<span class="id" title="var">system_log</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++(<span class="id" title="var">UserToKernel</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_regs</span>.(<span class="id" title="var">vcpu_regs</span>)::<span class="id" title="var">nil</span>)} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> <span class="id" title="var">new_st</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">save_regs_to_vcpu_call</span> (<span class="id" title="var">args</span> : <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)  :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">save_regs_to_vcpu_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerUB</span> "save_regs_to_vcpu: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Restore contexts and run.
     It also contains choosing the next vm to run by using an abstract scheduler  
   
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">vcpu_restore_and_run_spec</span>  :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
find out the next vm to be scheduled <ul class="doclist">
<li> Since we do not have any scheduler implementations, we introduced abstract scheduler 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">next_vm_id</span> := <span class="id" title="var">scheduler</span> <span class="id" title="var">st</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
check whether the current running entity is Hafnium 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "vcpu_restore_and_run: wrong cur entity id" ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>) = <span class="id" title="var">true</span>) &amp;&amp; (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">next_vm_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; </div>

<div class="doc">
get the userspace information 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "vcpu_restore_and_run: Cannot find userspace information",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_userspace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">next_vm_id</span> <span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; </div>

<div class="doc">
get vm context to restore the userspace information 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "vcpu_restore_and_run: Cannot find vm context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">next_vm_id</span> <span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;  </div>

<div class="doc">
get vcpu register information 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span>  "vcpu_restore_and_run: Cannot find vcpu index from kernel vm context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span>  "vcpu_restore_and_run: cannot find vcpu index from user vm context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">vm_userspace</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">append_all</span> ["vcpu_restore_and_run: Extract the curretnt vcpu context ";<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HexString.of_Z</span> <span class="id" title="var">next_vm_id</span>; " ";<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HexString.of_Z</span> <span class="id" title="var">cur_kernel_vcpu_index</span>; " ";<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HexString.of_Z</span> <span class="id" title="var">cur_user_vcpu_index</span>; " "]),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_regs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "vcpu_restore_and_run: inconsistency between kernel vm context and user vm context" ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">list_eq_dec</span> <span class="id" title="var">zeq</span> (<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_userspace</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus</span>)) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decide</span> (<span class="id" title="var">cur_kernel_vcpu_index</span> = <span class="id" title="var">cur_user_vcpu_index</span>) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decide</span> (<span class="id" title="var">cur_vcpu_regs</span>.(<span class="id" title="var">vm_id</span>) = <span class="id" title="var">Some</span> <span class="id" title="var">next_vm_id</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_userspace</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_userspace</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">client_vcpus_contexts</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_kernel_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_regs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vm_userspace</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vms_userspaces</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">next_vm_id</span> <span class="id" title="var">new_vm_userspace</span> <span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_st</span> := <span class="id" title="var">st</span> {<span class="id" title="var">is_hvc_mode</span>: <span class="id" title="var">false</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">cur_user_entity_id</span>: <span class="id" title="var">next_vm_id</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">hypervisor_context</span>/<span class="id" title="var">tpidr_el2</span>: <span class="id" title="var">None</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">vms_userspaces</span>: <span class="id" title="var">new_vms_userspaces</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">system_log</span> : <span class="id" title="var">st</span>.(<span class="id" title="var">system_log</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++(<span class="id" title="var">ChangeCurEntityID</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">next_vm_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::(<span class="id" title="var">KernelToUser</span> <span class="id" title="var">next_vm_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_regs</span>.(<span class="id" title="var">vcpu_regs</span>))::<span class="id" title="var">nil</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> <span class="id" title="var">new_st</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">vcpu_restore_and_run_call</span> (<span class="id" title="var">args</span> : <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)  :=             <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">vcpu_restore_and_run_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerUB</span> "vcpu_restore_and_run_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFAContextSwitching</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab165"></a><h2 class="section">FFA Dispatch</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFADispatch</span>.<br/>

<br/>
</div>

<div class="doc">
Function dispatch. It dispatch the proper specification based on 
      the value in the VCPU context 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Notation</span> <span class="id" title="var">HypervisorEE</span> := (<span class="id" title="var">CallExternalE</span> +' <span class="id" title="var">updateStateE</span> +' <span class="id" title="var">GlobalE</span> +' <span class="id" title="var">MemoryE</span> +' <span class="id" title="var">Event</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">dispatch_ffa_function</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_function_type</span>: <span class="id" title="var">FFA_FUNCTION_TYPE</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vid</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vals</span>: <span class="id" title="var">ZMap.t</span> <span class="id" title="var">Z</span>) (<span class="id" title="var">st</span> : <span class="id" title="var">AbstractState</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ffa_function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_DONATE gets four arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Total length

</li>
<li> Fragment length

</li>
<li> Address

</li>
<li> Page count 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_DONATE</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_donate_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 3 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 4 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_LEND gets four arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Total length

</li>
<li> Fragment length

</li>
<li> Address

</li>
<li> Page count 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_LEND</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_lend_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 3 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 4 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_SHARE gets four arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Total length

</li>
<li> Fragment length

</li>
<li> Address

</li>
<li> Page count 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_SHARE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_share_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 3 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 4 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_RETREIVE_REQ gets four arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Total length

</li>
<li> Fragment length

</li>
<li> Address

</li>
<li> Page count 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RETREIVE_REQ</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_retrieve_req_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 3 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 4 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_RETREIVE_RESP gets two arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Total length

</li>
<li> Fragment length 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RETREIVE_RESP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_retrieve_resp_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_RETREIVE_RESP doesn't have any arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details. 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RELINQUISH</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_relinquish_spec</span> <span class="id" title="var">vid</span> <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_RECLAIM gets three arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Handle (first half)

</li>
<li> Handle (second half)

</li>
<li> Falgs 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RECLAIM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_reclaim_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 3 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wrong_dispatch_ffa_function</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_function_type</span>: <span class="id" title="var">FFA_FUNCTION_TYPE</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vid</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vals</span>: <span class="id" title="var">ZMap.t</span> <span class="id" title="var">Z</span>) (<span class="id" title="var">st</span> : <span class="id" title="var">AbstractState</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ffa_function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> FFA_MEM_DONATE gets four arguments.
             See FFAMemoryHypCallAdditionalSteps.v for more details.
<ul class="doclist">
<li> Total length

</li>
<li> Fragment length

</li>
<li> Address

</li>
<li> Page count 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_DONATE</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">ffa_mem_donate_wrong_spec</span> <span class="id" title="var">vid</span> (<span class="id" title="var">ZMap.get</span> 1 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 2 <span class="id" title="var">vals</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.get</span> 3 <span class="id" title="var">vals</span>) (<span class="id" title="var">ZMap.get</span> 4 <span class="id" title="var">vals</span>) <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">dispatch_ffa_function</span> <span class="id" title="var">ffa_function_type</span> <span class="id" title="var">vid</span> <span class="id" title="var">vals</span> <span class="id" title="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
In Hafnium: Defined in "inc/hf/ffa_internal.h" 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">ffa_error</span> (<span class="id" title="var">ffa_error_code</span>: <span class="id" title="var">FFA_ERROR_CODE_TYPE</span>) : <span class="id" title="var">FFA_value_type</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">error_z_value</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ffa_error_code</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_NOT_SUPPORTED</span> <span class="id" title="var">_</span> =&gt; -1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INVALID_PARAMETERS</span> <span class="id" title="var">_</span> =&gt; -2 <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_NO_MEMORY</span> <span class="id" title="var">_</span> =&gt; -3<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_BUSY</span> <span class="id" title="var">_</span> =&gt; -4<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INTERRUPTED</span> <span class="id" title="var">_</span> =&gt; -5<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DENIED</span> <span class="id" title="var">_</span> =&gt; -6<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_RETRY</span> <span class="id" title="var">_</span> =&gt; -7<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_ABORTED</span> <span class="id" title="var">_</span> =&gt; -8<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkFFA_value_type</span> (<span class="id" title="var">FFA_RESULT_CODE_IDENTIFIER</span> (<span class="id" title="var">FFA_ERROR</span> <span class="id" title="var">ffa_error_code</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.set</span> 1 <span class="id" title="var">error_z_value</span> (<span class="id" title="var">ZMap.init</span> 0))).<br/>

<br/>
</div>

<div class="doc">
In Hafnium: Defined in "inc/vmapi/hf/ffa.h" 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">ffa_success</span> (<span class="id" title="var">handle</span>: <span class="id" title="var">Z</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkFFA_value_type</span> (<span class="id" title="var">FFA_RESULT_CODE_IDENTIFIER</span> (<span class="id" title="var">FFA_SUCCESS</span> <span class="id" title="var">handle</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.set</span> 2 (<span class="id" title="var">Z.land</span> <span class="id" title="var">handle</span> ((<span class="id" title="var">Z.shiftl</span> 1 32) - 1)%<span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZMap.set</span> 3 (<span class="id" title="var">Z.shiftr</span> <span class="id" title="var">handle</span> 32) (<span class="id" title="var">ZMap.init</span> 0)))).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">ffa_value_gen</span> (<span class="id" title="var">ffa_result_value</span> : <span class="id" title="var">FFA_RESULT_CODE_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ffa_result_value</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_ERROR</span> <span class="id" title="var">ffa_error_code</span> =&gt; <span class="id" title="var">ffa_error</span> <span class="id" title="var">ffa_error_code</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_SUCCESS</span> <span class="id" title="var">handle</span> =&gt; <span class="id" title="var">ffa_success</span> <span class="id" title="var">handle</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Notation</span> <span class="id" title="var">dispatch_ffa_function_type</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">FFA_FUNCTION_TYPE</span> -&gt; <span class="id" title="var">ffa_UUID_t</span> -&gt; <span class="id" title="var">ZMap.t</span> <span class="id" title="var">Z</span> -&gt; <span class="id" title="var">AbstractState</span> -&gt; <span class="id" title="var">RESULT</span> (<span class="id" title="var">AbstractState</span> * <span class="id" title="var">FFA_RESULT_CODE_TYPE</span>))%<span class="id" title="keyword">type</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">ffa_dispatch_spec</span> (<span class="id" title="var">dispatch_func</span> : <span class="id" title="var">dispatch_ffa_function_type</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;:  <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">bool</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Extract the current vcpu 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Get the information in tpidr_el2 register to find out the current VM to be served 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "ffa_dispatch: vcpu value is not proper",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_regs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">tpidr_el2</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">vcpu_regs</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">mkVCPU_struct</span> (<span class="id" title="var">Some</span> <span class="id" title="var">cid</span>) (<span class="id" title="var">Some</span> <span class="id" title="var">vid</span>) <span class="id" title="var">arch_regs</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">arch_regs</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">mkArchRegs</span> (<span class="id" title="var">mkFFA_value_type</span> <span class="id" title="var">func_type</span> <span class="id" title="var">vals</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">func_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_FUNCTION_IDENTIFIER</span> <span class="id" title="var">ffa_function_type</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Find out the result of the FFA ABI calls by using the proper handling functions 
</li>
</ul>

</div>
<div class="code">
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_st</span> := <span class="id" title="var">st</span> {<span class="id" title="var">system_log</span>: <span class="id" title="var">st</span>.(<span class="id" title="var">system_log</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++(<span class="id" title="var">DispathFFAInterface</span> <span class="id" title="var">arch_regs</span>)::<span class="id" title="var">nil</span>} <span class="id" title="tactic">in</span>     <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">dispatch_func</span> <span class="id" title="var">ffa_function_type</span> <span class="id" title="var">vid</span> <span class="id" title="var">vals</span> <span class="id" title="var">new_st</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">SUCCESS</span> <span class="id" title="var">result</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">result</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" title="var">updated_st</span>, <span class="id" title="var">ffa_result</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Set the result inside the updated state 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "ffa_dispatch: error in getting vm_context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vid</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">updated_st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "ffa_dispatch: error in getting vcpu index",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "ffa_dispatch: error in getting saved vcpu index",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_reg</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_kernel_vcpu_index</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="keyword">let</span> <span class="id" title="var">new_vcpu_reg</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVCPU_struct</span> (<span class="id" title="var">vcpu_reg</span>.(<span class="id" title="var">cpu_id</span>)) (<span class="id" title="var">vcpu_reg</span>.(<span class="id" title="var">vm_id</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkArchRegs</span> (<span class="id" title="var">ffa_value_gen</span> <span class="id" title="var">ffa_result</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_context</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">vm_vcpus_contexts</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_index</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_vcpu_reg</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_st</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">updated_st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">hypervisor_context</span> / <span class="id" title="var">vms_contexts</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">vid</span> <span class="id" title="var">new_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">updated_st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> <span class="id" title="var">new_st</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">new_st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FAIL</span> <span class="id" title="var">msg</span> =&gt; <span class="id" title="var">triggerUB</span> <span class="id" title="var">msg</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerUB</span> "ffa_dispatch_spec: function identifier is not proper"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerUB</span> "ffa_dispatch_spec: erros in vcpu struct value"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">ffa_dispatch_call</span> (<span class="id" title="var">args</span> : <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)  :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">result</span> &lt;- (<span class="id" title="var">ffa_dispatch_spec</span> <span class="id" title="var">dispatch_ffa_function</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">val</span> := <span class="id" title="keyword">match</span> <span class="id" title="var">result</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">true</span> =&gt; <span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> 1))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> 0))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">val</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerUB</span> "ffa_dispatch_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wrong_ffa_dispatch_call</span> (<span class="id" title="var">args</span> : <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)  :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">result</span> &lt;- (<span class="id" title="var">ffa_dispatch_spec</span> <span class="id" title="var">wrong_dispatch_ffa_function</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">val</span> := <span class="id" title="keyword">match</span> <span class="id" title="var">result</span> <span class="id" title="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">true</span> =&gt; <span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> 1))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> 0))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">val</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerUB</span> "wrong_ffa_dispatch_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFADispatch</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab166"></a><h2 class="section">Client Setter and Getter</h2>
<a name="lab167"></a><h3 class="section">FFA Interface Values</h3>
 This section defines Z type interface values for FFA calls 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_DATATYPES</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">abstract_state_context</span>: <span class="id" title="var">AbstractStateContext</span>}.<br/>

<br/>
</div>

<div class="doc">
The following types are defined in Chapter 11 (Memory management interfaces document) 
      They are ignored in our modeling. 
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>: 0x84000071

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span>: 0x84000072

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span>: 0x84000073

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_REQ</span></span>: 0x84000074

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_RESP</span></span>: 0x84000075

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RELINQUISH</span></span>: 0x84000076

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RECLAIM</span></span>: 0x84000077

</li>
</ul>
   
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_DONATE_32</span> : <span class="id" title="var">Z</span> := 2214592625.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_LEND_32</span> : <span class="id" title="var">Z</span> := 2214592626.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_SHARE_32</span> : <span class="id" title="var">Z</span> := 2214592627.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_RETRIEVE_REQ_32</span> : <span class="id" title="var">Z</span> := 2214592628.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_RETRIEVE_RESP_32</span> : <span class="id" title="var">Z</span> := 2214592629.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_RELINGQUISH_32</span> : <span class="id" title="var">Z</span> := 2214592630.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEM_RECLAIM_32</span> : <span class="id" title="var">Z</span> := 2214592631.<br/>

<br/>
</div>

<div class="doc">
The followings are for return values of FFA interface calls.  The following numbers are defined in Chapter 7, especially in Table 7.2: Error status codes
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_NOT_SUPPORTED</span></span>: -1

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_INVALID_PARAMETERS</span></span>: -2

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_NO_MEMORY</span></span>: -3

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_BUSY</span></span>: -4

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_INTERRUPTED</span></span>: -5

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_DENIED</span></span>: -6

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_RETRY</span></span>: -7

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_ABORTED</span></span>: -8

</li>
</ul>
  
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_NOT_SUPPORTED_32</span> : <span class="id" title="var">Z</span> := -1.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_INVALID_PARAMETERS_32</span> : <span class="id" title="var">Z</span> := -2.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_NO_MEMORY_32</span> : <span class="id" title="var">Z</span> := -3.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_BUSY_32</span> : <span class="id" title="var">Z</span> := -4.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_INTERRUPTED_32</span> : <span class="id" title="var">Z</span> := -5.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_DENIED_32</span> : <span class="id" title="var">Z</span> := -6.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_RETRY_32</span> : <span class="id" title="var">Z</span> := -7.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_ABORTED_32</span> : <span class="id" title="var">Z</span> := -8.<br/>

<br/>
</div>

<div class="doc">
The following numbers are also defined in Chapter 7
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_ERROR</span></span>: 0x84000060

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_SUCCESS</span></span>: 0x84000061

</li>
</ul>
   
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_ERROR_32</span> : <span class="id" title="var">Z</span> := 2214592608.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_SUCCESS_32</span> : <span class="id" title="var">Z</span> := 2214592609.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">Z_to_FFA_Function_Type</span> (<span class="id" title="var">value</span> : <span class="id" title="var">Z</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_DONATE_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_DONATE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_LEND_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_LEND</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_SHARE_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_SHARE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_RETRIEVE_REQ_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_RETREIVE_REQ</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_RETRIEVE_RESP_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_RETREIVE_RESP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_RELINGQUISH_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_RELINQUISH</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">value</span> = <span class="id" title="var">FFA_MEM_RECLAIM_32</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_RECLAIM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_Result_Type_to_Z</span> (<span class="id" title="var">res</span> : <span class="id" title="var">FFA_RESULT_CODE_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">res</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_SUCCESS</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">FFA_SUCCESS_32</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_ERROR</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">FFA_ERROR_32</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_DATATYPES</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab168"></a><h2 class="section">Client modeling</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">InterfaceFunctions</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab169"></a><h3 class="section">Address translation</h3>
 Memory load and store operations 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">stage2_get_physical_address_spec</span> (<span class="id" title="var">st</span>: <span class="id" title="var">AbstractState</span>) (<span class="id" title="var">addr</span> : <span class="id" title="var">ffa_address_t</span>)<br/>
&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">ffa_UUID_t</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">stage2_address_translation_table</span> <span class="id" title="var">addr</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">res</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">page_num</span> := <span class="id" title="var">Z.div</span> <span class="id" title="var">res</span> <span class="id" title="var">granuale</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.get</span> <span class="id" title="var">page_num</span> <span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>).(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">property</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">property</span>.(<span class="id" title="var">accessible_by</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">ExclusiveAccess</span> <span class="id" title="var">accessor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">check</span> "stage2_address_translation_table error",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) = <span class="id" title="var">accessor</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">res</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">SharedAccess</span> <span class="id" title="var">accessors</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">check</span> "stage2_address_translation_table error",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)) <span class="id" title="var">accessors</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">res</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "stage2_address_translation_table error"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "stage2_address_translation_table error"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "stage2_address_translation_table error"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_physical_address_spec</span> (<span class="id" title="var">addr</span> : <span class="id" title="var">ffa_address_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">ffa_UUID_t</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">stage2_get_physical_address_spec</span> <span class="id" title="var">st</span> <span class="id" title="var">addr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">st</span>.(<span class="id" title="var">use_stage1_table</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "stage1_address_translation_table error",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">stage1_address_translation_table</span> <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="var">addr</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">stage2_get_physical_address_spec</span> <span class="id" title="var">st</span> <span class="id" title="var">res'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">stage2_get_physical_address_spec</span> <span class="id" title="var">st</span> <span class="id" title="var">addr</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_physical_address_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">addr</span>))]  =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">get_physical_address_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">addr</span>) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">res</span>)), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "get_physical_address_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab170"></a><h3 class="section">Logical flag changes</h3>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_is_hvc_mode_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "set_is_hvc_mode: invalid mode",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">is_hvc_mode</span> : <span class="id" title="var">true</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_is_hvc_mode_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| []  =&gt; <span class="id" title="var">set_is_hvc_mode_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_use_stage2_table_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">unset_is_hvc_mode_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "unset_is_hvc_mode: invalid mode",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">is_hvc_mode</span> : <span class="id" title="var">false</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">unset_is_hvc_mode_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| []  =&gt; <span class="id" title="var">unset_is_hvc_mode_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "unset_is_hvc_mode_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">is_hvc_mode_getter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Z</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>)) <span class="id" title="keyword">then</span> <span class="id" title="var">Ret</span> (1) <span class="id" title="keyword">else</span> <span class="id" title="var">Ret</span> (0).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">is_hvc_mode_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| []  =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">is_hvc_mode_getter_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">res</span>)), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "unset_is_hvc_mode_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_use_stage1_table_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "set_use_stage1_table: invalid mode",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">use_stage1_table</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">use_stage1_table</span> : <span class="id" title="var">true</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_use_stage1_table_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| []  =&gt; <span class="id" title="var">set_use_stage1_table_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_use_stage2_table_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">unset_use_stage1_table_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "unset_use_stage1_table: invalid mode",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">st</span>.(<span class="id" title="var">use_stage1_table</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">use_stage1_table</span> : <span class="id" title="var">false</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">unset_use_stage1_table_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| []  =&gt; <span class="id" title="var">unset_use_stage1_table_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "unset_use_stage2_table_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab171"></a><h3 class="section">Setter/Getter for buffer</h3>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_buffer_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">receiver</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">size</span> : <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">ffa_buffer_msg_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">recv_func</span> : <span class="id" title="var">FFA_FUNCTION_TYPE</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">state</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "set_buffer: invalid receiver",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">receiver</span> <span class="id" title="var">entity_list</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">sender</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">receiver_buffer_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">receiver</span> = <span class="id" title="var">hypervisor_id</span>) <span class="id" title="keyword">then</span> <span class="id" title="var">sender</span> <span class="id" title="keyword">else</span> <span class="id" title="var">receiver</span> <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> (<span class="id" title="var">append_all</span> ["set_buffer: error in getting vm_context";<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HexString.of_Z</span> <span class="id" title="var">receiver_buffer_id</span>]),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">receiver_buffer_id</span> <span class="id" title="var">state</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">buffer_contents</span> := <span class="id" title="var">mkBUFFER_struct</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg</span> (<span class="id" title="var">Some</span> <span class="id" title="var">sender</span>) <span class="id" title="var">size</span> (<span class="id" title="var">Some</span> <span class="id" title="var">recv_func</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_context</span> := <span class="id" title="var">vm_context</span> {<span class="id" title="var">vm_buffer</span> : <span class="id" title="var">buffer_contents</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">receiver_buffer_id</span> <span class="id" title="var">new_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">state</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">state</span> {<span class="id" title="var">hypervisor_context</span> / <span class="id" title="var">vms_contexts</span> : <span class="id" title="var">new_vm_contexts</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">system_log</span>: (<span class="id" title="var">SetBuffer</span> <span class="id" title="var">sender</span> <span class="id" title="var">receiver</span> <span class="id" title="var">buffer_contents</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::(<span class="id" title="var">state</span>.(<span class="id" title="var">system_log</span>))})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_buffer_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">receiver</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">size</span>)); (<span class="id" title="var">Vabs</span> <span class="id" title="var">buffer_msg</span>); (<span class="id" title="var">Vabs</span> <span class="id" title="var">recv_func</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">buffer_msg</span> <span class="id" title="var">ffa_buffer_msg_t</span>, <span class="id" title="var">downcast</span> <span class="id" title="var">recv_func</span> <span class="id" title="var">FFA_FUNCTION_TYPE</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">msg</span>, <span class="id" title="var">Some</span> <span class="id" title="var">func_type</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">set_buffer_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">receiver</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">size</span>) <span class="id" title="var">msg</span> <span class="id" title="var">func_type</span> ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_buffer_call: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_buffer_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_buffer_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">FFAMemoryHypCallState.ffa_buffer_msg_t</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">current_vm_id</span> := <span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "get_buffer: error in getting vm_context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">current_vm_id</span> <span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">vm_context</span>.(<span class="id" title="var">buffer</span>).(<span class="id" title="var">message</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_buffer_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">get_buffer_spec</span>;;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">res</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "get_buffer_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab172"></a><h3 class="section">Setter/Getter for buffer with ID</h3>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_buffer_with_sender_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">sender</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">receiver</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">size</span> : <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">msg</span> : <span class="id" title="var">ffa_buffer_msg_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">recv_func</span> : <span class="id" title="var">FFA_FUNCTION_TYPE</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">state</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "set_buffer_with_sender: invalid sender and/or receiver" ,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">sender</span> <span class="id" title="var">entity_list</span>) &amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">receiver</span> <span class="id" title="var">entity_list</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="keyword">let</span> <span class="id" title="var">sender</span> := <span class="id" title="var">state</span>.(<span class="id" title="var">cur_user_entity_id</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">receiver_buffer_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">receiver</span> = <span class="id" title="var">hypervisor_id</span>) <span class="id" title="keyword">then</span> <span class="id" title="var">sender</span> <span class="id" title="keyword">else</span> <span class="id" title="var">receiver</span> <span class="id" title="tactic">in</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> (<span class="id" title="var">append_all</span> ["set_buffer_with_sender: error in getting vm_context";<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">HexString.of_Z</span> <span class="id" title="var">receiver_buffer_id</span>]),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">receiver_buffer_id</span> <span class="id" title="var">state</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">buffer_contents</span> := <span class="id" title="var">mkBUFFER_struct</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">msg</span> (<span class="id" title="var">Some</span> <span class="id" title="var">sender</span>) <span class="id" title="var">size</span> (<span class="id" title="var">Some</span> <span class="id" title="var">recv_func</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_context</span> := <span class="id" title="var">vm_context</span> {<span class="id" title="var">vm_buffer</span> : <span class="id" title="var">buffer_contents</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">receiver_buffer_id</span> <span class="id" title="var">new_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">state</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">state</span> {<span class="id" title="var">hypervisor_context</span> / <span class="id" title="var">vms_contexts</span> : <span class="id" title="var">new_vm_contexts</span>}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="id" title="var">system_log</span>: (<span class="id" title="var">SetBuffer</span> <span class="id" title="var">sender</span> <span class="id" title="var">receiver</span> <span class="id" title="var">buffer_contents</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::(<span class="id" title="var">state</span>.(<span class="id" title="var">system_log</span>))})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span>  <span class="id" title="var">set_buffer_with_sender_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">sender</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">receiver</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">size</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Vabs</span> <span class="id" title="var">buffer_msg</span>); (<span class="id" title="var">Vabs</span> <span class="id" title="var">recv_func</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">buffer_msg</span> <span class="id" title="var">ffa_buffer_msg_t</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">downcast</span> <span class="id" title="var">recv_func</span> <span class="id" title="var">FFA_FUNCTION_TYPE</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">msg</span>, <span class="id" title="var">Some</span> <span class="id" title="var">func_type</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">set_buffer_with_sender_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">sender</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">receiver</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">size</span>) <span class="id" title="var">msg</span> <span class="id" title="var">func_type</span> ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_buffer_with_sender_call: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_buffer_with_sender_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_buffer_with_receiver_id_spec</span> (<span class="id" title="var">receiver</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">FFAMemoryHypCallState.ffa_buffer_msg_t</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "get_buffer: invalid receiver",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">receiver</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "get_buffer: error in getting vm_context",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">receiver</span> <span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">vm_context</span>.(<span class="id" title="var">buffer</span>).(<span class="id" title="var">message</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">get_buffer_with_receiver_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">receiver</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">get_buffer_with_receiver_id_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">receiver</span>);;  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">res</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "get_buffer_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">InterfaceFunctions</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab173"></a><h2 class="section">FFA Memory Management Interface Module</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">MemSetterGetter</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab174"></a><h3 class="section">Global property getter / setter</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">global_properties_getter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">MemGlobalProperties</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "global_properties_getter: page number out of range",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">page_low</span> &lt;= <span class="id" title="var">page_num</span>)%<span class="id" title="var">Z</span> &amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">page_num</span> &lt; <span class="id" title="var">page_high</span>)%<span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "global_properties_getter_spec: no properties in the map",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">v</span> &lt;- <span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">page_num</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">v</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">global_properties_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">page_num</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">global_properties_getter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">page_num</span>) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">res</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "global_properties_getter: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">global_properties_setter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global_properties</span>: <span class="id" title="var">MemGlobalProperties</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span> ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "global_properties_setter: page number out of range",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">page_low</span> &lt;= <span class="id" title="var">page_num</span>)%<span class="id" title="var">Z</span> &amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">page_num</span> &lt; <span class="id" title="var">page_high</span>)%<span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="keyword">let</span> <span class="id" title="var">mem_props</span> := <span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_mem_global_props_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:= <span class="id" title="var">ZTree.set</span> <span class="id" title="var">page_num</span> <span class="id" title="var">global_properties</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mem_props</span>.(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_mem_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkMemProperties</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_mem_global_props_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mem_props</span>.(<span class="id" title="var">mem_local_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">hypervisor_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" title="var">mem_properties</span>: <span class="id" title="var">new_mem_props</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">global_properties_setter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">addr</span>)); (<span class="id" title="var">Vabs</span> <span class="id" title="var">global_properties</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">global_properties</span> <span class="id" title="var">MemGlobalProperties</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">global_props</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">global_properties_setter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">addr</span>) <span class="id" title="var">global_props</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "global_properties_setter: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "global_properties_setter: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab175"></a><h3 class="section">Local property getter / setter</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">local_properties_getter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">owner</span> : <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">MemLocalProperties</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "local_properties_getter: page number out of range",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">page_low</span> &lt;= <span class="id" title="var">page_num</span>)%<span class="id" title="var">Z</span> &amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">page_num</span> &lt; <span class="id" title="var">page_high</span>)%<span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "local_properties_getter: no local property pool in the map",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">local_props_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">owner</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_local_properties</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "local_properties_getter: no properties in the map",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">value</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">page_num</span> <span class="id" title="var">local_props_pool</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span>(<span class="id" title="var">value</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">local_properties_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">owner</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">page_num</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;-  <span class="id" title="var">local_properties_getter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">owner</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">page_num</span>) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "local_properties_getter: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">local_properties_setter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">owner</span> : <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">local_properties</span>: <span class="id" title="var">MemLocalProperties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "local_properties_setter: page number out of range",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">page_low</span> &lt;= <span class="id" title="var">page_num</span>)%<span class="id" title="var">Z</span> &amp;&amp; <span class="id" title="var">decide</span> (<span class="id" title="var">page_num</span> &lt; <span class="id" title="var">page_high</span>)%<span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "local_properties_setter: no local property pool in the map",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">local_props_local_pool</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">owner</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_local_properties</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;     <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_local_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">page_num</span> <span class="id" title="var">local_properties</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">local_props_local_pool</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_local_props_pool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span> <span class="id" title="var">owner</span> <span class="id" title="var">new_local_props</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_local_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_mem_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkMemProperties</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_local_props_pool</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">hypervisor_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" title="var">mem_properties</span>: <span class="id" title="var">new_mem_props</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">local_properties_setter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">owner</span>));(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">page_num</span>)); (<span class="id" title="var">Vabs</span> <span class="id" title="var">local_properties</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">local_properties</span> <span class="id" title="var">MemLocalProperties</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">local_props</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">local_properties_setter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">owner</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">page_num</span>) <span class="id" title="var">local_props</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "local_properties_setter: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "local_properties_setter: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab176"></a><h3 class="section">Set / clean mem dirty + mem dirty getter</h3>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_mem_dirty_spec</span> (<span class="id" title="var">writer</span>: <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">page_num</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">mkMemGlobalProperties</span> <span class="id" title="var">is_ns</span> <span class="id" title="var">owner</span> <span class="id" title="var">access</span> <span class="id" title="var">inst_access</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access</span> <span class="id" title="var">mem_attr</span> <span class="id" title="var">mem_dirty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="keyword">let</span> <span class="id" title="var">new_mem_dirty</span> := <span class="id" title="keyword">match</span> <span class="id" title="var">mem_dirty</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MemClean</span> =&gt; <span class="id" title="var">MemWritten</span> (<span class="id" title="var">writer</span>::<span class="id" title="var">nil</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MemWritten</span> <span class="id" title="var">writers</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">writer</span> <span class="id" title="var">writers</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">MemWritten</span> <span class="id" title="var">writers</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">MemWritten</span> (<span class="id" title="var">writer</span>::<span class="id" title="var">writers</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_global_prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkMemGlobalProperties</span> <span class="id" title="var">is_ns</span> <span class="id" title="var">owner</span> <span class="id" title="var">access</span> <span class="id" title="var">inst_access</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access</span> <span class="id" title="var">mem_attr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_mem_dirty</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_global_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">page_num</span> <span class="id" title="var">new_global_prop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_mem_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkMemProperties</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_global_props</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_local_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">hypervisor_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" title="var">mem_properties</span>: <span class="id" title="var">new_mem_props</span>}))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_mem_dirty: cannot find property"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">set_mem_dirty_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">writer</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">addr</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">set_mem_dirty_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">writer</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">addr</span>) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_mem_dirty_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">clean_mem_dirty_spec</span> (<span class="id" title="var">writer</span>: <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">page_num</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">mkMemGlobalProperties</span> <span class="id" title="var">is_ns</span> <span class="id" title="var">owner</span> <span class="id" title="var">access</span> <span class="id" title="var">inst_access</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access</span> <span class="id" title="var">mem_attr</span> <span class="id" title="var">mem_dirty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="keyword">let</span> <span class="id" title="var">new_global_prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkMemGlobalProperties</span> <span class="id" title="var">is_ns</span> <span class="id" title="var">owner</span> <span class="id" title="var">access</span> <span class="id" title="var">inst_access</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access</span> <span class="id" title="var">mem_attr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">MemClean</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_global_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ZTree.set</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">page_num</span> <span class="id" title="var">new_global_prop</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_mem_props</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkMemProperties</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_global_props</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_local_properties</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">hypervisor_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/ <span class="id" title="var">mem_properties</span>: <span class="id" title="var">new_mem_props</span>}))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "clean_mem_dirty: cannot find property"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">clean_mem_dirty_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">writer</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">addr</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">clean_mem_dirty_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">writer</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">addr</span>) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_mem_dirty_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_dirty_getter_spec</span> (<span class="id" title="var">writer</span>: <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">page_num</span>: <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">MEM_DIRTY_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">page_num</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">mem_properties</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">mem_global_properties</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> (<span class="id" title="var">mkMemGlobalProperties</span> <span class="id" title="var">is_ns</span> <span class="id" title="var">owner</span> <span class="id" title="var">access</span> <span class="id" title="var">inst_access</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access</span> <span class="id" title="var">mem_attr</span> <span class="id" title="var">mem_dirty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">Ret</span> (<span class="id" title="var">mem_dirty</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "clean_mem_dirty: cannot find property"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_dirty_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">writer</span>)); (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">addr</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">res</span> &lt;- <span class="id" title="var">mem_dirty_getter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">writer</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">addr</span>) ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">res</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "set_mem_dirty_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">MemSetterGetter</span>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">EntityIDSetterGetter</span>.<br/>
</div>

<div class="doc">
<a name="lab177"></a><h3 class="section">current entity id getter / setter</h3>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">current_entity_id_getter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">ffa_UUID_t</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>)) <span class="id" title="keyword">then</span> <span class="id" title="var">Ret</span> (<span class="id" title="var">hypervisor_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Ret</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span>  <span class="id" title="var">current_entity_id_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">entity_id</span> &lt;- <span class="id" title="var">current_entity_id_getter_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">entity_id</span>)), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "get_current_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">current_entity_id_setter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">entity_id</span> : <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "current_entity_id_setter_spec: invalid input",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">st</span> {<span class="id" title="var">cur_user_entity_id</span>: <span class="id" title="var">entity_id</span>})).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">current_entity_id_setter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">current_entity_id_setter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "get_current_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">EntityIDSetterGetter</span>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">VCPUSetterGetter</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab178"></a><h3 class="section">userspace vcpu index getter / setter</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_getter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">ffa_VCPU_ID_t</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_index_getter: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">cur_user_entity_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_index_getter: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_index_getter: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">cur_user_vcpu_id</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_index</span> &lt;- <span class="id" title="var">userspace_vcpu_index_getter_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">vcpu_index</span>)), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_index_getter_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_setter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vcpu_index</span> : <span class="id" title="var">ffa_VCPU_ID_t</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_index_setter: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">cur_user_entity_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_index_setter: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_user_vm_context</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVM_USERSPACE_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">vcpu_index</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_user_entity_id</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_state</span> := <span class="id" title="var">st</span> {<span class="id" title="var">vms_userspaces</span> : <span class="id" title="var">new_vm_contexts</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">new_state</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_setter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">value</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">userspace_vcpu_index_setter_spec</span> (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">value</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_index_setter_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab179"></a><h2 class="section">userspace vcpu index getter / setter with entity id</h2>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span> : <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">ffa_VCPU_ID_t</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_index_getter_with_entity_id: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_index_getter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_index_getter_with_entity_id: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_index_getter_with_entity_id: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">cur_user_vcpu_id</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_getter_with_entity_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_index</span> &lt;- <span class="id" title="var">userspace_vcpu_index_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">vcpu_index</span>)), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_index_getter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vcpu_index</span> : <span class="id" title="var">ffa_VCPU_ID_t</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_index_setter_with_entity_id: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_index_setter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_index_setter_with_entity_id: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_user_vm_context</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVM_USERSPACE_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">vcpu_index</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_user_entity_id</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_state</span> := <span class="id" title="var">st</span> {<span class="id" title="var">vms_userspaces</span> : <span class="id" title="var">new_vm_contexts</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">new_state</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_index_setter_with_entity_id_call</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>); <span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">value</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">userspace_vcpu_index_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">value</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_index_setter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab180"></a><h2 class="section">kernel vcpu index getter / setter with entity id</h2>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_index_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span> : <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">ffa_VCPU_ID_t</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "kernel_vcpu_index_getter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "kernel_vcpu_index_getter_with_entity_id: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "kernel_vcpu_index_getter_with_entity_id: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">cur_kernel_vcpu_id</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_index_getter_with_entity_id_call</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [(<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>))] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_index</span> &lt;- <span class="id" title="var">kernel_vcpu_index_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">vcpu_index</span>)), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "kernel_vcpu_index_getter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_index_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">vcpu_index</span> : <span class="id" title="var">ffa_VCPU_ID_t</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "kernel_vcpu_index_setter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "kernel_vcpu_index_setter_with_entity_id: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_kernel_vm_context</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVM_KERNEL_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">vcpu_index</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">buffer</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_user_entity_id</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_kernel_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_state</span> := <span class="id" title="var">st</span> {<span class="id" title="var">hypervisor_context</span> / <span class="id" title="var">vms_contexts</span> : <span class="id" title="var">new_vm_contexts</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">new_state</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_index_setter_with_entity_id_call</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>); <span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">value</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">kernel_vcpu_index_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>) (<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">value</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "kernel_vcpu_index_setter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab181"></a><h2 class="section">userspace vcpu getter / setter</h2>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_getter_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">VCPU_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_struct_getter: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">cur_user_entity_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_struct_getter: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_struct_getter: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_struct_getter: does not have vcpu values",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_values</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">cur_vcpu_values</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_getter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_values</span>&lt;- <span class="id" title="var">userspace_vcpu_struct_getter_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">vcpu_values</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_struct_getter_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_setter_spec</span> (<span class="id" title="var">vcpu_values</span>: <span class="id" title="var">VCPU_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_struct_setter: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">cur_user_entity_id</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">st</span>.(<span class="id" title="var">cur_user_entity_id</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_struct_setter: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_struct_setter: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vcpu_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_values</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_user_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVM_USERSPACE_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">cur_user_vcpu_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_vcpu_contexts</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_user_entity_id</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_user_vm_contexts</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_state</span> := <span class="id" title="var">st</span> {<span class="id" title="var">vms_userspaces</span> : <span class="id" title="var">new_vm_contexts</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">new_state</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_setter_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vabs</span> <span class="id" title="var">vcpu_struct_val</span>] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">vcpu_struct_val</span> <span class="id" title="var">VCPU_struct</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">vcpu_val</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">userspace_vcpu_struct_setter_spec</span> <span class="id" title="var">vcpu_val</span> ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_struct_setter_call: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_struct_setter_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab182"></a><h2 class="section">userspace vcpu getter / setter with entity ID</h2>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span> : <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">VCPU_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_struct_getter_with_entity_id: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_getter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;      <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_struct_getter_with_entity_id: 
      current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_struct_getter_with_entity_id: 
        current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_struct_getter_with_entity_id: 
        does not have vcpu values",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_values</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">cur_vcpu_values</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_getter_with_entity_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_values</span>&lt;- <span class="id" title="var">userspace_vcpu_struct_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">vcpu_values</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_struct_getter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span>: <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">vcpu_values</span>: <span class="id" title="var">VCPU_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_struct_setter_with_entity_id: invalid mode for this operation",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">negb</span> <span class="id" title="var">st</span>.(<span class="id" title="var">is_hvc_mode</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_struct_setter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;      <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "userspace_vcpu_struct_setter: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "userspace_vcpu_struct_setter_with_entity_id: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vcpu_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_user_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_values</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_user_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVM_USERSPACE_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">cur_user_vcpu_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_vm_context</span>.(<span class="id" title="var">vm_userspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_vcpu_contexts</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_user_entity_id</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_user_vm_contexts</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">vms_userspaces</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_state</span> := <span class="id" title="var">st</span> {<span class="id" title="var">vms_userspaces</span> : <span class="id" title="var">new_vm_contexts</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">new_state</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">userspace_vcpu_struct_setter_with_entity_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>); <span class="id" title="var">Vabs</span> <span class="id" title="var">vcpu_struct_val</span>] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">vcpu_struct_val</span> <span class="id" title="var">VCPU_struct</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">vcpu_val</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">userspace_vcpu_struct_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>) <span class="id" title="var">vcpu_val</span> ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_struct_setter_with_entity_id_call: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "userspace_vcpu_struct_setter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab183"></a><h2 class="section">kernel vcpu getter / setter with entity ID</h2>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_struct_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span> : <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">VCPU_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "kernel_vcpu_getter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;      <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "kernel_vcpu_struct_getter_with_entity_id: 
      current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "kernel_vcpu_struct_getter_with_entity_id: 
        current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "kernel_vcpu_struct_getter_with_entity_id: 
        does not have vcpu values",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_vcpu_values</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">Ret</span> (<span class="id" title="var">cur_vcpu_values</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_struct_getter_with_entity_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>)] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_values</span>&lt;- <span class="id" title="var">kernel_vcpu_struct_getter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">vcpu_values</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "kernel_vcpu_struct_getter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_struct_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_user_entity_id</span>: <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">vcpu_values</span>: <span class="id" title="var">VCPU_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">unit</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check</span> "userspace_vcpu_struct_setter_with_entity_id: invalid entity ID",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> (<span class="id" title="var">in_dec</span> <span class="id" title="var">zeq</span> <span class="id" title="var">cur_user_entity_id</span> <span class="id" title="var">vm_ids</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;      <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get</span> "kernel_vcpu_struct_setter: current user vm context does not exist",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vm_context</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">ZTree.get</span> <span class="id" title="var">cur_user_entity_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;; <span class="id" title="var">get</span> "kernel_vcpu_struct_setter_with_entity_id: current user vcpu id is invalid",<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;- (<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">cur_vcpu_index</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vcpu_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vcpu_id</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vcpu_values</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus_contexts</span>))) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_kernel_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkVM_KERNEL_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">mkVM_COMMON_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Some</span> <span class="id" title="var">cur_kernel_vcpu_id</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">vm_kernelspace_context</span>).(<span class="id" title="var">vcpus</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_vcpu_contexts</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cur_kernel_vm_context</span>.(<span class="id" title="var">buffer</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_vm_contexts</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ZTree.set</span> <span class="id" title="var">cur_user_entity_id</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">new_kernel_vm_contexts</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span>.(<span class="id" title="var">hypervisor_context</span>).(<span class="id" title="var">vms_contexts</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">new_state</span> := <span class="id" title="var">st</span> {<span class="id" title="var">hypervisor_context</span> / <span class="id" title="var">vms_contexts</span> : <span class="id" title="var">new_vm_contexts</span>} <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">SetState</span> (<span class="id" title="var">new_state</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">kernel_vcpu_struct_setter_with_entity_id_call</span> (<span class="id" title="var">args</span>: <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [<span class="id" title="var">Vcomp</span> (<span class="id" title="var">Vlong</span> <span class="id" title="var">entity_id</span>); <span class="id" title="var">Vabs</span> <span class="id" title="var">vcpu_struct_val</span>] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">downcast</span> <span class="id" title="var">vcpu_struct_val</span> <span class="id" title="var">VCPU_struct</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">vcpu_val</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">kernel_vcpu_struct_setter_with_entity_id_spec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Int64.unsigned</span> <span class="id" title="var">entity_id</span>) <span class="id" title="var">vcpu_val</span> ;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vnull</span>, <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "kernel_vcpu_struct_setter_with_entity_id_call: impossible conversion"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "kernel_vcpu_struct_setter_with_entity_id_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">VCPUSetterGetter</span>.<br/>

<br/>
<span class="id" title="keyword">Section</span> <span class="id" title="var">StateAndLogGetter</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">state_getter_spec</span><br/>
&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">AbstractState</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">st</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">state_getter_call</span> (<span class="id" title="var">args</span> : <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">state_getter_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">st</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "state_getter_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">system_log_getter_spec</span><br/>
&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">system_log_type</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">st</span> &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">GetState</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">st</span>.(<span class="id" title="var">system_log</span>)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">system_log_getter_call</span> (<span class="id" title="var">args</span> : <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">itree</span> <span class="id" title="var">HypervisorEE</span> (<span class="id" title="var">Lang.val</span> * <span class="id" title="var">list</span> <span class="id" title="var">Lang.val</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">args</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| [] =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">system_log</span> &lt;- <span class="id" title="var">system_log_getter_spec</span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Ret</span> (<span class="id" title="var">Vabs</span> (<span class="id" title="var">upcast</span> <span class="id" title="var">system_log</span>), <span class="id" title="var">args</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">triggerNB</span> "state_getter_call: wrong arguments"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">StateAndLogGetter</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab184"></a><h2 class="section">FFA Memory Management Interface Module</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFAMemoryManagementInterfaceModule</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">funcs</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.save_regs_to_vcpu", <span class="id" title="var">save_regs_to_vcpu_call</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.vcpu_restore_and_run", <span class="id" title="var">vcpu_restore_and_run_call</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.ffa_dispatch", <span class="id" title="var">ffa_dispatch_call</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.wrong_ffa_dispatch", <span class="id" title="var">wrong_ffa_dispatch_call</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.get_physical_address", <span class="id" title="var">get_physical_address_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.set_is_hvc_mode", <span class="id" title="var">set_is_hvc_mode_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.unset_is_hvc_mode", <span class="id" title="var">unset_is_hvc_mode_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.is_hvc_mode_getter", <span class="id" title="var">is_hvc_mode_getter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.set_use_stage1_table", <span class="id" title="var">set_use_stage1_table_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.unset_use_stage1_table", <span class="id" title="var">unset_use_stage1_table_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.current_entity_id_getter", <span class="id" title="var">current_entity_id_getter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.current_entity_id_setter", <span class="id" title="var">current_entity_id_setter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.set_buffer", <span class="id" title="var">set_buffer_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.get_buffer", <span class="id" title="var">get_buffer_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.set_buffer_with_sender_id", <span class="id" title="var">set_buffer_with_sender_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.get_buffer_with_receiver_id", <span class="id" title="var">get_buffer_with_receiver_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.global_properties_getter", <span class="id" title="var">global_properties_getter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.global_properties_setter", <span class="id" title="var">global_properties_setter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.local_properties_getter", <span class="id" title="var">local_properties_getter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.local_properties_setter", <span class="id" title="var">local_properties_setter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.set_mem_dirty", <span class="id" title="var">set_mem_dirty_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.clean_mem_dirty", <span class="id" title="var">clean_mem_dirty_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.userspace_vcpu_index_getter", <span class="id" title="var">userspace_vcpu_index_getter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.userspace_vcpu_index_setter", <span class="id" title="var">userspace_vcpu_index_setter_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.userspace_vcpu_index_getter_with_entity_id", <span class="id" title="var">userspace_vcpu_index_getter_with_entity_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.userspace_vcpu_index_setter_with_entity_id", <span class="id" title="var">userspace_vcpu_index_setter_with_entity_id_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.kernel_vcpu_index_getter_with_entity_id", <span class="id" title="var">kernel_vcpu_index_getter_with_entity_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.kernel_vcpu_index_setter_with_entity_id", <span class="id" title="var">kernel_vcpu_index_setter_with_entity_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.userspace_vcpu_struct_getter", <span class="id" title="var">userspace_vcpu_struct_getter_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.userspace_vcpu_struct_setter", <span class="id" title="var">userspace_vcpu_struct_setter_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.userspace_vcpu_struct_getter_with_entity_id", <span class="id" title="var">userspace_vcpu_struct_getter_with_entity_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.userspace_vcpu_struct_setter_with_entity_id", <span class="id" title="var">userspace_vcpu_struct_setter_with_entity_id_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.kernel_vcpu_struct_getter_with_entity_id", <span class="id" title="var">kernel_vcpu_struct_getter_with_entity_id_call</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.kernel_vcpu_struct_setter_with_entity_id", <span class="id" title="var">kernel_vcpu_struct_setter_with_entity_id_call</span>);<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.state_getter", <span class="id" title="var">state_getter_call</span>); <br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCToplevel.system_log_getter", <span class="id" title="var">system_log_getter_call</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;].<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">top_level_modsem</span> : <span class="id" title="var">ModSem</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mk_ModSem</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">s</span> =&gt; <span class="id" title="var">existsb</span> (<span class="id" title="var">string_dec</span> <span class="id" title="var">s</span>) (<span class="id" title="var">List.map</span> <span class="id" title="var">fst</span> <span class="id" title="var">funcs</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">_</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">initial_state</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">updateStateE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">updateState_handler</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">T</span> (<span class="id" title="var">c</span>: <span class="id" title="var">CallExternalE</span> <span class="id" title="var">T</span>) =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> '(<span class="id" title="var">CallExternal</span> <span class="id" title="var">func_name</span> <span class="id" title="var">args</span>) := <span class="id" title="var">c</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="keyword">fix</span> <span class="id" title="var">find_func</span> <span class="id" title="var">l</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">l</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| (<span class="id" title="var">f</span>, <span class="id" title="var">body</span>)::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">string_dec</span> <span class="id" title="var">func_name</span> <span class="id" title="var">f</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">body</span> <span class="id" title="var">args</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">find_func</span> <span class="id" title="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">triggerNB</span> "Not mpool func"<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">find_func</span> <span class="id" title="var">funcs</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br/>
&nbsp;&nbsp;.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFAMemoryManagementInterfaceModule</span>.<br/>

<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Lang</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Values</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Integers</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Constant</span>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">LangNotations</span>.<br/>
<span class="id" title="keyword">Local Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">expr_scope</span>.<br/>

<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">Int64</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab185"></a><h2 class="section">Hypervisor Call</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">HypervisorCall</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">hypervisor_call</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Call</span> "HVCTopLevel.save_regs_to_vcpu" [])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "hyp mode after entering kernel" (<span class="id" title="var">Call</span> "HVCTopLevel.is_hvc_mode_getter" []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "result" (<span class="id" title="var">Call</span> "HVCTopLevel.ffa_dispatch" []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "function_dispatcher has be invoked" <span class="id" title="var">Vnull</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Jieung: I do not figure out the reason, but it is required 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "hyp mode after dispatching" (<span class="id" title="var">Call</span> "HVCTopLevel.is_hvc_mode_getter" []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Call</span> "HVCTopLevel.vcpu_restore_and_run" [])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "hyp mode after restore" (<span class="id" title="var">Call</span> "HVCTopLevel.is_hvc_mode_getter" [])).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wrong_hypervisor_call</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Call</span> "HVCTopLevel.save_regs_to_vcpu" [])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "hyp mode after entering kernel" (<span class="id" title="var">Call</span> "HVCTopLevel.is_hvc_mode_getter" []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "result" (<span class="id" title="var">Call</span> "HVCTopLevel.wrong_ffa_dispatch" []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "function_dispatcher has be invoked" <span class="id" title="var">Vnull</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
Jieung: I do not figure out the reason, but it is required 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "hyp mode after dispatching" (<span class="id" title="var">Call</span> "HVCTopLevel.is_hvc_mode_getter" []))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Call</span> "HVCTopLevel.vcpu_restore_and_run" [])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Put</span> "hyp mode after restore" (<span class="id" title="var">Call</span> "HVCTopLevel.is_hvc_mode_getter" [])).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">scheduling</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Call</span> "HVCTopLevel.save_regs_to_vcpu" [])<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#; (<span class="id" title="var">Call</span> "HVCTopLevel.vcpu_restore_and_run" []).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">hypervisor_callF</span> : <span class="id" title="var">function</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mk_function_tac</span> <span class="id" title="var">hypervisor_call</span> ([]: <span class="id" title="var">list</span> <span class="id" title="var">var</span>) ([]: <span class="id" title="var">list</span> <span class="id" title="var">var</span>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wrong_hypervisor_callF</span> : <span class="id" title="var">function</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mk_function_tac</span> <span class="id" title="var">wrong_hypervisor_call</span> ([]: <span class="id" title="var">list</span> <span class="id" title="var">var</span>) ([]: <span class="id" title="var">list</span> <span class="id" title="var">var</span>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">schedulingF</span> : <span class="id" title="var">function</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mk_function_tac</span> <span class="id" title="var">scheduling</span> ([]: <span class="id" title="var">list</span> <span class="id" title="var">var</span>) ([]: <span class="id" title="var">list</span> <span class="id" title="var">var</span>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Defined</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">HypervisorCall</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab186"></a><h2 class="section">FFA Memory Management Interface Module With Mem Accessor</h2>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFAMemoryManagementInterfaceWithMemAccessorModule</span>.<br/>

<br/>
</div>

<div class="doc">
Arbitrarily assign the block number for users 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">flat_mem_block_ptr</span> := (<span class="id" title="var">Vptr</span> 2%<span class="id" title="var">positive</span> (<span class="id" title="var">Ptrofs.repr</span> 0)).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_store_spec</span> (<span class="id" title="var">addr</span> <span class="id" title="var">value</span> : <span class="id" title="var">var</span>) (<span class="id" title="var">entity_id</span> <span class="id" title="var">paddr</span> : <span class="id" title="var">var</span>) : <span class="id" title="var">stmt</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">entity_id</span> #= (<span class="id" title="var">Call</span> "HVCToplevel.current_entity_id_getter" []) #;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">paddr</span> #= (<span class="id" title="var">Call</span> "HVCTopLevel.get_physical_address" [<span class="id" title="var">CBV</span> <span class="id" title="var">addr</span>]) #;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Call</span> "HVCTopLevel.set_mem_dirty" [<span class="id" title="var">CBV</span> <span class="id" title="var">entity_id</span>; <span class="id" title="var">CBV</span> (<span class="id" title="var">addr</span> / (<span class="id" title="var">Int64.repr</span> <span class="id" title="var">granuale</span>))]) #;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">flat_mem_block_ptr</span> @ <span class="id" title="var">paddr</span> #:= <span class="id" title="var">value</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_load_spec</span> (<span class="id" title="var">addr</span> : <span class="id" title="var">var</span>) (<span class="id" title="var">paddr</span>: <span class="id" title="var">var</span>): <span class="id" title="var">stmt</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">paddr</span> #= (<span class="id" title="var">Call</span> "HVCTopLevel.get_physical_address" [<span class="id" title="var">CBV</span> <span class="id" title="var">addr</span>]) #;    <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Return</span> (<span class="id" title="var">flat_mem_block_ptr</span>  #@ <span class="id" title="var">paddr</span>).<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_store_specF</span>: <span class="id" title="var">function</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mk_function_tac</span> <span class="id" title="var">mem_store_spec</span> ["addr"; "value"] ["entity_id "; "paddr"].<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_load_specF</span>: <span class="id" title="var">function</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mk_function_tac</span> <span class="id" title="var">mem_load_spec</span> ["addr"] ["paddr"].<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Defined</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">mem_funcs</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;[<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.mem_store", <span class="id" title="var">mem_store_specF</span>) ;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.mem_load", <span class="id" title="var">mem_load_specF</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.hypervisor_call", <span class="id" title="var">hypervisor_callF</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.wrong_hypervisor_call", <span class="id" title="var">wrong_hypervisor_callF</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;("HVCTopLevel.scheduling", <span class="id" title="var">schedulingF</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;].<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">top_level_accessor_modsem</span> : <span class="id" title="var">ModSem</span> := <span class="id" title="var">program_to_ModSem</span> <span class="id" title="var">mem_funcs</span>.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFAMemoryManagementInterfaceWithMemAccessorModule</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>