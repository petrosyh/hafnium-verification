<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<link href="coqdoc.css" rel="stylesheet" type="text/css" />
<title>FFAMemoryHypCallDescriptorState</title>
</head>

<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Library FFAMemoryHypCallDescriptorState</h1>

<div class="code">
<span class="id" title="keyword">From</span> <span class="id" title="var">Coq</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Arith.PeanoNat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Lists.List</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Strings.String</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Morphisms</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Setoid</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">RelationClasses</span>.<br/>

<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">ExtLib</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">RelDec</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Data.String</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Structures.Monad</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Structures.Traversable</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Data.List</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Data.Option</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Data.Monads.OptionMonad</span>.<br/>

<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Decision</span>.<br/>

<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Coqlib</span> <span class="id" title="var">sflib</span>.<br/>

<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Export</span> <span class="id" title="var">FFAMemoryHypCall</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">FFAMemoryHypCallIntro</span>.<br/>

<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="var">Maps</span>.<br/>
<span class="id" title="keyword">Set Implicit Arguments</span>.<br/>

<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">Z_64MAX</span> := ((<span class="id" title="var">Z.pow</span> 2 64) - 1)%<span class="id" title="var">Z</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">Z_not</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">val</span> =&gt; (<span class="id" title="var">Z.lxor</span> <span class="id" title="var">Z_64MAX</span> <span class="id" title="var">val</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab32"></a><h1 class="section">Introduction</h1>

<div class="paragraph"> </div>

 This file contains formalizations for FFA memory management descriptors. The most relavant parts regarding 
    this file is from Section 5.10 to Section 5.12 in the document.

<div class="paragraph"> </div>

<a name="lab33"></a><h1 class="section">Types and Constant values that are used in FF</h1>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_TYPES_AND_CONSTANT</span>.<br/>

<br/>
</div>

<div class="doc">
Type definitions in the below are mostly type aliasing for the readability. 
      Most types are simply Z or bool types. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Class</span> <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> 2.8. Partition identification and discovery 
<ul class="doclist">
<li> 2.9. An execution context is identified by using a 16-bit ID. This ID is referred

</li>
</ul>
        to as the vCPU or execution context ID 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_UUID_t</span> : <span class="id" title="keyword">Type</span> := <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_VCPU_ID_t</span> : <span class="id" title="keyword">Type</span> := <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> 8.1. FFA_VERSION: 
        The first one is a major version number and the second one is for the minor version 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_version_number_t</span> : <span class="id" title="keyword">Type</span> := (<span class="id" title="var">Z</span> * <span class="id" title="var">Z</span>)%<span class="id" title="keyword">type</span>; <br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> For CPU ID values 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_CPU_ID_t</span> : <span class="id" title="keyword">Type</span> := <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> A bare address value that represent the memory PA 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_address_t</span> := <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_granuale_size_t</span> := <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Parts of return value types of FFA calls 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_memory_handle_t</span> := <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Type for one of descriptor information. They are only used in two FFA interfaces, 
        <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_REQ</span></span> and <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_RESP</span></span> 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_memory_receiver_flags_t</span> := <span class="id" title="var">bool</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Type for an implementation defined values that are used in 
        <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>, <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span>, and <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span>. So, we cannot specify the value by
        defining inductive types. In this sense, we define it as a general Type 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_memory_region_tag_t</span> : <span class="id" title="keyword">Type</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Granuale value. The actual granuale size is multiplication of granuale and 4096 (4KiB).
<ul class="doclist">
<li> For example, if the granuale is 2, then the actual granuale size of the system is 8192 (2 * 4096)

</li>
<li> This is due to reducing the overhead of several recursive functions that we need to 
            introduce with the memory addresses. If we use the current approach, we can represent bigger granuale
            numbers and memory address ranges without facing stack overflow 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">granuale</span> : <span class="id" title="var">ffa_granuale_size_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_ffa_memory_region_tag</span> : <span class="id" title="var">ffa_memory_region_tag_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_TYPES_AND_CONSTANT</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab34"></a><h1 class="section">FFA  keyword</h1>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_DATATYPES</span>.<br/>

<br/>
</div>

<div class="doc">
This section defines several keywords that are necessary to model 
      FFA memory management interfaces 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">ffa_types_and_constants</span>: <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span>}.<br/>

<br/>
</div>

<div class="doc">
The following types are defined in Chapter 11 (Memory management interfaces document).
      Integer values are not actually used in our formal definitions. However, those details are 
      handled in our test interface, <span class="inlinecode"><span class="id" title="var">FFAMemoryHypCallTestingInterface.v</span></span>. 
      FFA Memory management related ABIs are as follows:
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>
<ul class="doclist">
<li> Defined in Table 11.3 FFA_MEM_DONATE function syntax         

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span>
<ul class="doclist">
<li> Defined in Table 11.8 FFA_MEM_LEND function syntax           

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span>
<ul class="doclist">
<li> Defined in Table 11.13: FFA_MEM_SHARE function syntax        

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_REQ</span></span>
<ul class="doclist">
<li> Defined in Table 11.18 FFA_MEM_RETRIEVE_REQ function syntax  

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_RESP</span></span>
<ul class="doclist">
<li> Defined in Table 11.22: FFA_MEM_RETRIEVE_RESP function synta 

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RELINQUISH</span></span>
<ul class="doclist">
<li> Defined in Table 11.27: FFA_MEM_RELINQUISH function syntax   

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RECLAIM</span></span>
<ul class="doclist">
<li> Defined in Table 11.31: FFA_MEM_RECLAIM function syntax      

</li>
</ul>

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab35"></a><h4 class="section"> </h4>

<div class="paragraph"> </div>

<a name="lab36"></a><h4 class="section">FFA Function Type Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_FUNCTION_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_DONATE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_LEND</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_SHARE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RETREIVE_REQ</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RETREIVE_RESP</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RELINQUISH</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RECLAIM</span>.<br/>

<br/>
</div>

<div class="doc">
The following parts are not defined in Chapter 5, but in Chapter 7.

<div class="paragraph"> </div>

  Error codes are defined in Table 7.2: Error status codes
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_NOT_SUPPORTED</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_INVALID_PARAMETERS</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_NO_MEMORY</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_BUSY</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_INTERRUPTED</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_DENIED</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_RETRY</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_ABORTED</span></span>

</li>
</ul>
  
<div class="paragraph"> </div>

<a name="lab37"></a><h4 class="section"> </h4>

<div class="paragraph"> </div>

<a name="lab38"></a><h4 class="section">FFA Error Code Type Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_ERROR_CODE_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_NOT_SUPPORTED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_INVALID_PARAMETERS</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_NO_MEMORY</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_BUSY</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_INTERRUPTED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_DENIED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_RETRY</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_ABORTED</span>.<br/>

<br/>
</div>

<div class="doc">
The following numbers are also defined in Chapter 7
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_ERROR</span></span>
<ul class="doclist">
<li> Defined in Table 7.4: FFA_ERROR function syntax

</li>
</ul>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_SUCCESS</span></span> 
<ul class="doclist">
<li> Defined in Table 7.7: FFA_SUCCESS function syntax

</li>
</ul>

</li>
</ul>
  
<div class="paragraph"> </div>

<a name="lab39"></a><h3 class="section">FFA Result Code Type Coq Definition</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_RESULT_CODE_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_ERROR</span> (<span class="id" title="var">ffa_error_value</span> : <span class="id" title="var">FFA_ERROR_CODE_TYPE</span>) <br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_SUCCESS</span> (<span class="id" title="var">ffa_handle</span> : <span class="id" title="var">ffa_memory_handle_t</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab40"></a><h3 class="section">FFA Identifier Type Coq Definition</h3>
 This version only focus on two FFA interfaces, memory management related interfaces and interfaces for 
     the result of memory management related parts 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_IDENTIFIER_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_IDENTIFIER_DEFAULT</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_FUNCTION_IDENTIFIER</span> (<span class="id" title="var">func</span>: <span class="id" title="var">FFA_FUNCTION_TYPE</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_RESULT_CODE_IDENTIFIER</span> (<span class="id" title="var">func</span>: <span class="id" title="var">FFA_RESULT_CODE_TYPE</span>).<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_DATATYPES</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab41"></a><h1 class="section">FFA value structures</h1>
 This one is related to the interface definitions in Section 11 of the document.

<div class="paragraph"> </div>

    The following definitions are not parts of Section 5 in the document. However, they are essential when 
    defining memory management interfaces. 
</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_STRUCTURES</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">ffa_types_and_constants</span>: <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span>}.<br/>

<br/>
</div>

<div class="doc">
  Most A64 instructions operate on registers. The architecture provides 31 general purpose registers. 
  Each register can be used as a 64-bit X register (X0..X30), or as a 32-bit W register
  (W0..W30). These are two separate ways of looking at the same register. For example, this
  register diagram shows that W0 is the bottom 32 bits of X0, and W1 is the bottom 32 bits of X1:

<div class="paragraph"> </div>

  However, we model the minimum registers that are necessary for us to define FFA memory management interfaces. 
  We also referred Hafnium to find out the minimum registers that we need. 

<div class="paragraph"> </div>

  Register values are all Z types 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">reg_t</span> := <span class="id" title="var">PMap.t</span> <span class="id" title="var">Z</span>.<br/>

<br/>
</div>

<div class="doc">
The minimum register model that are necessary for modeling FFA memory management interfaces 
<ul class="doclist">
<li> The first value (func) contains FFA identifiers
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">func</span>;</span>  

</li>
</ul>

</li>
<li> Other 7 regiters contains several arguments of the FFA call (or, return value after serving the FFA call).
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg1</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg2</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg3</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg4</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg5</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg6</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">arg7</span>;</span>

</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

  
<div class="paragraph"> </div>

<a name="lab42"></a><h3 class="section">Formal definition of FFA value</h3>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_value_type</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_value_type</span>{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> This one is actually a register value, but we only use that as a FFA_IDENTIFIER_TYPE. Therefore, 
         
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_type</span> : <span class="id" title="var">FFA_IDENTIFIER_TYPE</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">TODO</span>:</span> <span class="inlinecode"><span class="id" title="tactic">do</span></span> <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="var">need</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">make</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span> <span class="inlinecode"><span class="id" title="var">conversion</span></span> <span class="inlinecode"><span class="id" title="var">from</span></span> <span class="inlinecode"><span class="id" title="var">each</span></span> <span class="inlinecode"><span class="id" title="var">arg</span></span> <span class="inlinecode"><span class="id" title="var">into</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">corresponding</span></span> <span class="inlinecode"><span class="id" title="var">descriptors</span>?</span> 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">vals</span> : <span class="id" title="var">ZMap.t</span> <span class="id" title="var">Z</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
Default value 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_value_type</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_value_type</span> <span class="id" title="var">FFA_IDENTIFIER_DEFAULT</span> (<span class="id" title="var">ZMap.init</span> 0).<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_STRUCTURES</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab43"></a><h1 class="section">Descriptors</h1>
 <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="var">following</span></span> <span class="inlinecode"><span class="id" title="var">parts</span></span> <span class="inlinecode"><span class="id" title="var">are</span></span> <span class="inlinecode"><span class="id" title="var">related</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode">&quot;5.10</span> <span class="inlinecode"><span class="id" title="var">Memory</span></span> <span class="inlinecode"><span class="id" title="var">region</span></span> <span class="inlinecode"><span class="id" title="var">description</span>&quot;</span> <span class="inlinecode"><span class="id" title="var">and</span></span> <span class="inlinecode">&quot;5.11</span> <span class="inlinecode"><span class="id" title="var">Memory</span></span> <span class="inlinecode"><span class="id" title="var">region</span></span> <span class="inlinecode"><span class="id" title="var">properties</span>&quot;</span> 
</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_DESCRIPTIONS</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab44"></a><h2 class="section">5.10 Memory region description</h2>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

      A memory region is described in a memory management transaction either through a Composite memory region
      descriptor (see 5.10.1 Composite memory region descriptor) or a globally unique Handle (see 5.10.2 Memory
      region handle).

<div class="paragraph"> </div>

      The former is used to describe a memory region when a transaction to share, lend or donate memory is 
      initiated by the Owner and when the memory region is retrieved by the Receiver.

<div class="paragraph"> </div>

      The latter is used to describe a memory region when it is retrieved by a Receiver, relinquished by a 
      Borrower and reclaimed by the Owner.
   
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">ffa_types_and_constants</span>: <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span>}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab45"></a><h3 class="section">Constituent memory region and composite_memory_region descriptors</h3>
 <span class="inlinecode"><span class="id" title="var">We</span></span> <span class="inlinecode"><span class="id" title="var">define</span></span> <span class="inlinecode"><span class="id" title="var">descriptors</span></span> <span class="inlinecode"><span class="id" title="var">that</span></span> <span class="inlinecode"><span class="id" title="var">are</span></span> <span class="inlinecode"><span class="id" title="var">used</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">FFA</span></span> <span class="inlinecode"><span class="id" title="var">interfaces</span>.</span> <span class="inlinecode"><span class="id" title="var">Sender</span>,</span> <span class="inlinecode"><span class="id" title="var">Relayer</span>,</span> <span class="inlinecode"><span class="id" title="var">and</span></span> <span class="inlinecode"><span class="id" title="var">Borrower</span></span> <span class="inlinecode"><span class="id" title="var">use</span></span> <span class="inlinecode"><span class="id" title="var">them</span></span> 
      <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">figure</span></span> <span class="inlinecode"><span class="id" title="var">out</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">information</span></span> <span class="inlinecode"><span class="id" title="var">and</span></span> <span class="inlinecode"><span class="id" title="var">check</span></span> <span class="inlinecode"><span class="id" title="var">validity</span></span> <span class="inlinecode"><span class="id" title="keyword">of</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">query</span></span> <span class="inlinecode"><span class="id" title="tactic">by</span></span> <span class="inlinecode"><span class="id" title="keyword">using</span></span> <span class="inlinecode"><span class="id" title="var">them</span></span>  A memory region is described in a memory management transaction by specifying the list and count of 4K sized
      pages that constitute it (see Table 5.13). 

<div class="paragraph"> </div>

      <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">due</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">dependency</span>,</span> <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="var">reordered</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">table</span>.</span> <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="tactic">first</span></span> <span class="inlinecode"><span class="id" title="var">introduce</span></span> <span class="inlinecode"><span class="id" title="var">Table</span></span> <span class="inlinecode">5.14,</span> <span class="inlinecode"><span class="id" title="keyword">then</span></span> 
      <span class="inlinecode"><span class="id" title="var">introduce</span></span> <span class="inlinecode"><span class="id" title="var">Table</span></span> <span class="inlinecode">5.13</span> 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

      The list is specified by using one or more constituent memory region descriptors (see Table 5.14). 
      Each descriptor specifies the base address and size of a virtually or physically contiguous memory region.

<div class="paragraph"> </div>

      Table 5.14: Constituent memory region descriptor
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">address</span>;</span>: base IPA of the constituent memory region, aligned to 4 kiB page size granularity.
        The number of 4 kiB pages in the constituent memory region. 

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">page_count</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">reserved</span>;</span>: Reserved field, must be 0.

</li>
</ul>
   
</div>
<div class="code">

<br/>
</div>

<div class="doc">
     The pages are addressed using VAs, IPAs or PAs depending on the FF-A instance at which the transaction is taking
     place. This is as follows.
<ul class="doclist">
<li> VAs are used at a Secure virtual FF-A instance if the partition runs in Secure EL0 or Secure User mode.

</li>
<li> IPAs are used at a virtual FF-A instance if the partition runs in one of the following Exception levels.
<ul class="doclist">
<li> Secure EL1.

</li>
<li> Secure Supervisor mode.

</li>
<li> EL1.

</li>
<li> Supervisor mode.

</li>
</ul>

</li>
<li> PAs are used at all physical FF-A instances.

</li>
</ul>

<div class="paragraph"> </div>

     Figure 5.2 describes a virtually contiguous memory region range VA_0 of size 16K through its composite memory
     region descriptors at the virtual and physical FF-A instances. VA_0 was allocated through a dynamic memory
     management mechanism inside an endpoint for example, malloc. It is composed of:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Two constituent IPA regions IPA_0 and IPA_1 of size 8K each at the virtual FF-A instance.

</li>
<li> IPA_0 is comprised of two PA regions PA_0 and PA_1 at the physical FF-A instance. Each PA region is of
       size 4K.

</li>
<li> IPA_1 is comprised of two PA regions PA_2 and PA_3 at the physical FF-A instance. Each PA region is of
       size 4K.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab46"></a><h4 class="section">FFA Memory Region Constituent Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_memory_region_constituent_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_region_constituent_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 8 bytes / offset: 0 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_constituent_struct_address</span> : <span class="id" title="var">ffa_address_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 4 bytes / offset: 4 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_constituent_struct_page_count</span> : <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> reserved MBZ - length: 4 bytes / offset: 12 byte 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_memory_region_constituent_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_region_constituent_struct</span> 0 0.<br/>

<br/>
</div>

<div class="doc">
Table 5.13: Composite memory region descriptor - A set of pages comprising a memory region. 
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">page_count</span>;</span>: The total number of 4 kiB pages included in this memory region. 
        This must be equal to the sum of page counts specified in each 
        <span class="inlinecode"><span class="id" title="var">ffa_memory_region_constituent</span></span> which is defined the above. 

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">constituent_count</span>;</span>: The number of constituents (<span class="inlinecode"><span class="id" title="var">ffa_memory_region_constituent</span></span>) 
        included in this memory region range.

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">reserved_0</span>;</span>: Reserved field, must be 0. 

</li>
<li> <span class="inlinecode"><span class="id" title="keyword">struct</span></span> <span class="inlinecode"><span class="id" title="var">ffa_memory_region_constituent</span>*</span> <span class="inlinecode"><span class="id" title="var">constituents</span>;</span>: An array of `constituent_count` memory region constituents.

</li>
</ul>
   
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab47"></a><h4 class="section">FFA Composition Memory Region Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_composite_memory_region_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_composite_memory_region_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 4 bytes / offset: 0 bytes  
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_composite_memory_region_struct_page_count</span> : <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_composite_memory_region_struct_constituent_count</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">Z</span>;</span> 
              <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="var">ignored</span></span> <span class="inlinecode"><span class="id" title="var">this</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="tactic">by</span></span> <span class="inlinecode"><span class="id" title="var">representing</span></span> <span class="inlinecode"><span class="id" title="var">constituents</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="keyword">as</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span> <span class="inlinecode"><span class="id" title="var">list</span></span> 
              <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" title="var">length</span>:</span> <span class="inlinecode">4</span> <span class="inlinecode"><span class="id" title="var">bytes</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" title="var">offset</span>:</span> <span class="inlinecode">4</span> <span class="inlinecode"><span class="id" title="var">bytes</span></span> <span class="inlinecode"></span>
</li>
</ul>
<ul class="doclist">
<li> reserved - legnth: 8 bytes / offset: 8 bytes 
</li>
</ul>
<ul class="doclist">
<li> length: 16 bytes * num of elements / offset: 16 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_composite_memory_region_struct_constituents</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">list</span> <span class="id" title="var">FFA_memory_region_constituent_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_composite_memory_region_struct</span> := <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_composite_memory_region_struct</span> 0 <span class="id" title="var">nil</span>.<br/>

<br/>
</div>

<div class="doc">
Basic well-formedness condition
<ul class="doclist">
<li> "Figure 5.2: Example memory region description" shows how those two are related 

</li>
<li> Some parts in 5.12 also explains invariants that the above definitions has to satisfy 
        (addresses should not be overlapped)

</li>
<li> <span class="inlinecode"><span class="id" title="var">TODO</span>:</span> <span class="inlinecode"><span class="id" title="var">Need</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">add</span></span> <span class="inlinecode"><span class="id" title="var">more</span></span> <span class="inlinecode"><span class="id" title="var">conditions</span></span>

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab48"></a><h4 class="section">Well formed conditions</h4>
 Check addresses in multiple constituents to see whether they are disjoint 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">check_overlap_in_ranges</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ranges</span> : <span class="id" title="var">list</span> (<span class="id" title="var">Z</span> * <span class="id" title="var">Z</span>)) (<span class="id" title="var">range</span> : (<span class="id" title="var">Z</span> * <span class="id" title="var">Z</span>)) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">ranges</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check_overlap_in_ranges</span> <span class="id" title="var">tl</span> <span class="id" title="var">range</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">decide</span> ((<span class="id" title="var">fst</span> <span class="id" title="var">hd</span>) &gt; (<span class="id" title="var">snd</span> <span class="id" title="var">range</span>)) || <span class="id" title="var">decide</span> ((<span class="id" title="var">fst</span> <span class="id" title="var">range</span>) &gt; <span class="id" title="var">snd</span> (<span class="id" title="var">hd</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">check_overlap_of_constituents_aux</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">constituents</span> : <span class="id" title="var">list</span> <span class="id" title="var">FFA_memory_region_constituent_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ranges</span> : <span class="id" title="var">list</span> (<span class="id" title="var">Z</span> * <span class="id" title="var">Z</span>)) : <span class="id" title="var">option</span> (<span class="id" title="var">list</span> (<span class="id" title="var">Z</span> * <span class="id" title="var">Z</span>)) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">constituents</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">Some</span> <span class="id" title="var">ranges</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">check_overlap_of_constituents_aux</span> <span class="id" title="var">tl</span> <span class="id" title="var">ranges</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">ranges'</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">first_addr</span> := <span class="id" title="var">hd</span>.(<span class="id" title="var">FFA_memory_region_constituent_struct_address</span>) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">last_addr</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">first_addr</span> +<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">granuale</span> *<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">hd</span>.(<span class="id" title="var">FFA_memory_region_constituent_struct_page_count</span>))%<span class="id" title="var">Z</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">check_overlap_in_ranges</span> <span class="id" title="var">ranges'</span> (<span class="id" title="var">first_addr</span>, <span class="id" title="var">last_addr</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> ((<span class="id" title="var">first_addr</span>, <span class="id" title="var">last_addr</span>)::<span class="id" title="var">ranges'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_overlap_of_constituents</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">constituents</span> : <span class="id" title="var">list</span> <span class="id" title="var">FFA_memory_region_constituent_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">check_overlap_of_constituents_aux</span> <span class="id" title="var">constituents</span> <span class="id" title="var">nil</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Check well formed conditions 
<ul class="doclist">
<li> Page count needs to be consistent

</li>
<li> All addresses can be divided by granuale 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">well_formed_FFA_composite_memory_region_struct_aux</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">page_counts</span> : <span class="id" title="var">Z</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">constituents</span> : <span class="id" title="var">list</span> <span class="id" title="var">FFA_memory_region_constituent_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">constituents</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">page_counts</span> = 0) <span class="id" title="keyword">then</span> <span class="id" title="var">true</span> <span class="id" title="keyword">else</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">hd</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">mkFFA_memory_region_constituent_struct</span> <span class="id" title="var">address</span> <span class="id" title="var">page_count</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">Z.modulo</span> <span class="id" title="var">address</span> <span class="id" title="var">granuale</span> = 0) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">decide</span> ((<span class="id" title="var">page_counts</span> - <span class="id" title="var">page_count</span>)%<span class="id" title="var">Z</span> &gt;= 0) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">well_formed_FFA_composite_memory_region_struct_aux</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">page_counts</span> - <span class="id" title="var">page_count</span>) <span class="id" title="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">well_formed_FFA_composite_memory_region_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">composite</span>: <span class="id" title="var">FFA_composite_memory_region_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">well_formed_FFA_composite_memory_region_struct_aux</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">composite</span>.(<span class="id" title="var">FFA_composite_memory_region_struct_page_count</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">composite</span>.(<span class="id" title="var">FFA_composite_memory_region_struct_constituents</span>)) &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">check_overlap_of_constituents</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">composite</span>.(<span class="id" title="var">FFA_composite_memory_region_struct_constituents</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab49"></a><h3 class="section">Memory region handle</h3>
 Handle : 64-bit, and the handle is allocated by teh replayer 
<ul class="doclist">
<li> A 64-bit Handle is used to identify a composite memory region description for example, VA_0 described in
       Figure 5.2

</li>
<li> The Handle is allocated by the Relayer as follows.
       – The SPM must allocate the Handle if any Receiver participating in the memory management transaction
         is an SP or SEPID associated with a Secure Stream ID in the SMMU.
       – The Hypervisor must allocate the Handle if no Receiver participating in the memory management
         transaction is an SP or SEPID associated with a Secure Stream ID in the SMMU.

</li>
<li> A Handle is allocated once a transaction to lend, share or donate memory is successfully 
       initiated by the Owner.

</li>
<li> Each Handle identifies a single unique composite memory region description that is, 
       there is a 1:1 mapping between the two.

</li>
<li> A Handle is freed by the Relayer after it has been reclaimed by its Owner at the end 
       of a successful transaction to relinquish the corresponding memory region description.

</li>
<li> Encoding of a Handle is as follows.
       – Bit(63): Handle allocator.
<ul class="doclist">
<li> b0: Allocated by SPM.

</li>
<li> b1: Allocated by Hypervisor.

</li>
</ul>

</li>
<li> Bit(62:0): IMPLEMENTATION DEFINED.

</li>
<li> A Handle must be encoded as a register parameter in any ABI that requires it as follows.
<ul class="doclist">
<li> Two 32-bit general-purpose registers must be used such that if Rx and Ry are used, such that x &lt; y,
<ul class="doclist">
<li> Rx = Handle(31:0).

</li>
<li> Ry = Handle(63:32). 
</li>
</ul>

</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

 Memory region handle in Hafnium is actually the index of "share_state_pool" 
      defined in FFAMemoryHypCallState.v) 
      which contains the information that receivers has to look up. 
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab50"></a><h2 class="section">5.11 Memory region properties</h2>
<a name="lab51"></a><h3 class="section">Constituent memory region and composite_memory_region descriptors</h3>

<div class="paragraph"> </div>

 From here, most parts are related to 5.11 Memory region properties.
<ul class="doclist">
<li> Instruction and data access permissions describe the type of access permitted on the memory region.

</li>
<li> One or more endpoint IDs that have access to the memory region specified by a combination of access
       permissions and memory region attributes.

</li>
<li> Memory region attributes control the memory type, accesses to the caches, and whether 
       the memory region is Shareable and therefore is coherent.

</li>
</ul>

<div class="paragraph"> </div>

     ffa data access and instruction access permission values are used in the memory access
     permissions descriptor (In Table 5.15: Memory access permissions descriptor). 
   
<div class="paragraph"> </div>

 There is a 1:1 association between an endpoint and the permissions with which it can access a memory region.
      This is specified in Table 5.15. 
<div class="paragraph"> </div>


<div class="paragraph"> </div>

    Execute permission is more permissive than Execute-never permission. 
<ul class="doclist">
<li> 5.11.3 Instruction access permissions usage 

</li>
<li> Table 5.15: Memory access permissions descriptor 

</li>
</ul>
  
<div class="paragraph"> </div>

<a name="lab52"></a><h4 class="section">FFA Instruction Access Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NOT_SPECIFIED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_RESERVED</span>.<br/>

<br/>
</div>

<div class="doc">
    Read-write permission is more permissive than Read-only permission. 
<ul class="doclist">
<li> 5.11.2 Data access permissions usage shows invariants about this fields 

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab53"></a><h4 class="section">FFA Data Access Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_NOT_SPECIFIED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RESERVED</span>.<br/>

<br/>
</div>

<div class="doc">
FFA memory access permissions descriptor
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">ffa_vm_id_t</span></span> <span class="inlinecode"><span class="id" title="var">receiver</span>;</span>: The ID of the VM to which the memory is being given or shared. 

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_access_permissions_t</span></span> <span class="inlinecode"><span class="id" title="var">permissions</span>;</span>: 
       The permissions with which the memory region should be mapped in the receiver's page table.       

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_receiver_flags_t</span></span> <span class="inlinecode"><span class="id" title="var">flags</span>;</span>:
       Flags used during FFA_MEM_RETRIEVE_REQ and FFA_MEM_RETRIEVE_RESP for memory regions with multiple borrowers.

</li>
</ul>
  
<div class="paragraph"> </div>


<div class="paragraph"> </div>

   A composite memory region description is referenced by specifying an offset to it as described in Table 5.16.
   This enables one or more endpoints to be associated with the same memory region but with different memory
   access permissions for example, SP0 could have RO data access permission and SP1 could have RW data access
   permission to the same memory region.
   
<div class="paragraph"> </div>

<a name="lab54"></a><h4 class="section">Order of instruction access and data access to check</h4>

      whether a is more permissive. 
<ul class="doclist">
<li> It will return true if a is more permissive than b. 

</li>
<li> It will return false in the following two cases.
<ul class="doclist">
<li> When b is more permissive than a.

</li>
<li> When a or b has an invalid value. 
          <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">We</span></span> <span class="inlinecode"><span class="id" title="var">can</span></span> <span class="inlinecode"><span class="id" title="var">easily</span></span> <span class="inlinecode"><span class="id" title="var">add</span></span> <span class="inlinecode"><span class="id" title="var">option</span></span> <span class="inlinecode"><span class="id" title="keyword">type</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">required</span></span> <span class="inlinecode"><span class="id" title="var">later</span>,</span> <span class="inlinecode"><span class="id" title="var">but</span></span> <span class="inlinecode"><span class="id" title="var">handling</span></span> <span class="inlinecode"><span class="id" title="var">them</span></span>
                   <span class="inlinecode"><span class="id" title="keyword">as</span></span> <span class="inlinecode"><span class="id" title="var">false</span></span> <span class="inlinecode"><span class="id" title="var">might</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">good</span></span> <span class="inlinecode"><span class="id" title="tactic">at</span></span> <span class="inlinecode"><span class="id" title="var">this</span></span> <span class="inlinecode"><span class="id" title="var">moment</span></span> 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_access_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">a</span> <span class="id" title="var">b</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) : <span class="id" title="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">a</span>, <span class="id" title="var">b</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span>, <span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span>, <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span>, <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span>, <span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
invalid pairs 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">data_access_permissive</span> (<span class="id" title="var">a</span> <span class="id" title="var">b</span>: <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>) : <span class="id" title="var">bool</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">a</span>, <span class="id" title="var">b</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span>, <span class="id" title="var">FFA_DATA_ACCESS_RW</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span>, <span class="id" title="var">FFA_DATA_ACCESS_RO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span>, <span class="id" title="var">FFA_DATA_ACCESS_RO</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span>, <span class="id" title="var">FFA_DATA_ACCESS_RW</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
invalid pairs 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>

<br/>

<br/>
</div>

<div class="doc">
<a name="lab55"></a><h4 class="section">FFA Memory Access Permissions Descriptor Coq Definitoin</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_memory_access_permissions_descriptor_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_access_permissions_descriptor_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_receiver</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 2 bytes / offset: 0 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_UUID_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> memory access permissions: length: 1 bytes / offset: 2 bytes
<ul class="doclist">
<li> bits(7:4): Reserved (MBZ).

</li>
<li> bits(3:2): Instruction access permission.
<ul class="doclist">
<li> b00: Not specified and must be ignored.

</li>
<li> b01: Not executable.

</li>
<li> b10: Executable.

</li>
<li> b11: Reserved. Must not be used.

</li>
</ul>

</li>
<li> bits(1:0): Data access permission.
<ul class="doclist">
<li> b00: Not specified and must be ignored.

</li>
<li> b01: Read-only.

</li>
<li> b10: Read-write.

</li>
<li> b11: Reserved. Must not be used. 
</li>
</ul>

</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_permisions_instruction</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_permisions_data</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> the flag value is only used for <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_REQ</span></span> and <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_RESP</span></span>. For 
             <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>, <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span>, and <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span>, this field is empty. They need to be 
             enforced as invariants.

<div class="paragraph"> </div>


</li>
<li> ABI-specific flags usage <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="keyword">Check</span></span> <span class="inlinecode"><span class="id" title="keyword">for</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">flag</span></span> <span class="inlinecode"><span class="id" title="tactic">field</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">required</span></span>

</li>
<li> An endpoint can specify properties specific to the memory management ABI being invoked through 
             this field. In this version of the Framework, the Flags field MBZ and is reserved in an 
             invocation of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>

</li>
<li> The Flags field must be encoded by the Receiver and the Relayer as specified in Table 5.17 in an 
             invocation of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_RETRIEVE_REQ.

</li>
<li> FFA_MEM_RETRIEVE_RESP.

</li>
</ul>

</li>
<li> The Relayer must return INVALID_PARAMETERS if the Flags field has been incorrectly encoded.

<div class="paragraph"> </div>


</li>
<li> Table 5.17: Flags usage in FFA_MEM_RETRIEVE_REQ and FFA_MEM_RETRIEVE_RESP ABIs

<div class="paragraph"> </div>


</li>
<li> Bit(0): Non-retrieval Borrower flag.
<ul class="doclist">
<li> In a memory management transaction with multiple Borrowers, during the retrieval
               of the memory region, this flag specifies if the memory region must be or was
               retrieved on behalf of this endpoint or if the endpoint is another Borrower.
<ul class="doclist">
<li> b0: Memory region must be or was retrieved on behalf of this endpoint.

</li>
<li> b1: Memory region must not be or was not retrieved on behalf of this endpoint.
                 It is another Borrower of the memory region.

</li>
</ul>

</li>
<li> This field MBZ if this endpoint:
<ul class="doclist">
<li> Is the only PE endpoint Borrower/Receiver in the transaction.

</li>
<li> Is a Stream endpoint and the caller of the FFA_MEM_RETRIEVE_REQ ABI is
                 its proxy endpoint.

</li>
</ul>

</li>
</ul>

</li>
<li> Bit(7:1) - Reserved (MBZ). 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_flags</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ffa_memory_receiver_flags_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_memory_access_permissions_descriptor_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_access_permissions_descriptor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NOT_SPECIFIED</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_DATA_ACCESS_NOT_SPECIFIED</span> <span class="id" title="var">false</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab56"></a><h4 class="section">Well formed conditions</h4>
 The call should return INVALID_PARAMETERS when the following is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_flags_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">function_type</span> : <span class="id" title="var">FFA_FUNCTION_TYPE</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_memory_access_permissions_descriptor_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">receiver_number</span>: <span class="id" title="var">Z</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_DONATE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_LEND</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_SHARE</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">descriptor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_flags</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>) <span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RETREIVE_REQ</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_RETREIVE_RESP</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">receiver_number</span> &gt; 1) <span class="id" title="keyword">then</span>  <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> (<span class="id" title="var">descriptor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct_flags</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Don't care about this case 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
     Table 5.16 specifies the data structure that is used in memory management transactions to create an association
     between an endpoint, memory access permissions and a composite memory region description.

<div class="paragraph"> </div>

     This data structure must be included in other data structures that are used in memory management transactions
     instead of being used as a stand alone data structure (see 5.12 Lend, donate, and share transaction descriptor).
     A composite memory region description is referenced by specifying an offset to it as described in Table 5.16.
     This enables one or more endpoints to be associated with the same memory region but with different memory
     access permissions for example, SP0 could have RO data access permission and SP1 could have RW data access
     permission to the same memory region. 
<div class="paragraph"> </div>

 Table 5.16: Endpoint memory access descriptor 
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="keyword">struct</span></span> <span class="inlinecode"><span class="id" title="var">ffa_memory_region_attributes</span></span> <span class="inlinecode"><span class="id" title="var">receiver_permissions</span>;</span>: 
        Offset in bytes from the start of the outer <span class="inlinecode"><span class="id" title="var">ffa_memory_region</span></span> to an <span class="inlinecode"><span class="id" title="var">ffa_composite_memory_region</span></span> struct.

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">composite_memory_region_offset</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">reserved_0</span>;</span>

</li>
</ul>
   
</div>
<div class="code">

<br/>

<br/>
</div>

<div class="doc">
<a name="lab57"></a><h4 class="section">FFA Endpoint Memory Access Descriptor Coq Definitoin</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_endpoint_memory_access_descriptor_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_endpoint_memory_access_descriptor_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 4 bytes / offset: 0 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_endpoint_memory_access_descriptor_struct_memory_access_permissions_descriptor</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_access_permissions_descriptor_struct</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 4 bytes / offset: 4 bytes 
</li>
</ul>
<ul class="doclist">
<li> It indicates one of constituents inside the composite_memory_region_struct to 
            retrieve specific memory region 
</li>
</ul>
<ul class="doclist">
<li> 0 and 1 is used for the specific purpose in this offset 
<ul class="doclist">
<li> 0 : points out this data structure 

</li>
<li> 1 : points out the composite descriptor 

</li>
<li> 2 : points out constituents that the composite descriptor holds

</li>
</ul>
         
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_access_descriptor_struct_composite_memory_region_offset</span> : <span class="id" title="var">nat</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> memory region struct is created and destroyed when hypervisor starts/finishes 
            their handling. Instead of merging it into  

<div class="paragraph"> </div>

<ul class="doclist">
<li> NOTE: the original size of the above offset value is as follows 
</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

<ul class="doclist">
<li> Reserved (MBZ) - length: 8 bytes / offset: 8 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_endpoint_memory_access_descriptor_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_endpoint_memory_access_descriptor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">init_FFA_memory_access_permissions_descriptor_struct</span> 0.<br/>

<br/>
</div>

<div class="doc">
<a name="lab58"></a><h4 class="section">Well formed conditions</h4>
 <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="var">error</span></span> <span class="inlinecode"><span class="id" title="var">code</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">defined</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">following</span></span> <span class="inlinecode"><span class="id" title="var">offset</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">correct</span>.</span> 
      <span class="inlinecode"><span class="id" title="var">I</span></span> <span class="inlinecode"><span class="id" title="var">will</span></span> <span class="inlinecode"><span class="id" title="keyword">return</span></span> <span class="inlinecode"><span class="id" title="var">INVALID_PARAMETER</span></span> <span class="inlinecode"><span class="id" title="keyword">for</span></span> <span class="inlinecode"><span class="id" title="var">this</span></span> <span class="inlinecode"><span class="id" title="tactic">case</span></span> 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">well_formed_FFA_endpoint_memory_access_descriptor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">access_descriptor</span> : <span class="id" title="var">FFA_endpoint_memory_access_descriptor_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">composite_descriptor</span> : <span class="id" title="var">FFA_composite_memory_region_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">offset</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">access_descriptor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_memory_access_descriptor_struct_composite_memory_region_offset</span>))%<span class="id" title="var">nat</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(((<span class="id" title="var">length</span> (<span class="id" title="var">composite_descriptor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_composite_memory_region_struct_constituents</span>)) + 2)%<span class="id" title="var">nat</span> &gt;=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">offset</span>)%<span class="id" title="var">nat</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">false</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab59"></a><h3 class="section">5.11.2 Data access permissions usage</h3>

<div class="paragraph"> </div>

      An endpoint could have either Read-only or Read-write data access permission to a memory region from the
      highest Exception level it runs in.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Read-write permission is more permissive than Read-only permission.

</li>
<li> Data access permission is specified by setting Bits(1:0) in Table 5.15 to the appropriate value

</li>
</ul>

<div class="paragraph"> </div>

      This access control is used in memory management transactions as follows.

<div class="paragraph"> </div>

      <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">We</span></span> <span class="inlinecode"><span class="id" title="tactic">do</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">model</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="tactic">case</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">endpoints</span></span> <span class="inlinecode"><span class="id" title="var">are</span></span> <span class="inlinecode"><span class="id" title="var">independent</span></span> <span class="inlinecode"><span class="id" title="var">peripheral</span></span> <span class="inlinecode"><span class="id" title="var">device</span></span> <span class="inlinecode"><span class="id" title="var">or</span></span>
      <span class="inlinecode"><span class="id" title="var">they</span></span> <span class="inlinecode"><span class="id" title="var">are</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">secure</span></span> <span class="inlinecode"><span class="id" title="var">regime</span></span>
   
<div class="paragraph"> </div>


<div class="paragraph"> </div>

      Restrictions in lend or share memory:
<ul class="doclist">
<li> The Lender must specify the level of access that the Borrower is permitted to have on the memory region.
        This is done while invoking the FFA_MEM_SHARE or FFA_MEM_LEND ABIs.

</li>
<li> The Relayer must validate the permission specified by the Lender as follows. This is done in response
        to an invocation of the FFA_MEM_SHARE or FFA_MEM_LEND ABIs. The Relayer must return the
        DENIED error code if the validation fails.
<ul class="doclist">
<li> At the Non-secure physical FF-A instance, an IMPLEMENTATION DEFINED mechanism is used to perform validation.
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="var">above</span></span> <span class="inlinecode"><span class="id" title="var">sentence</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">vague</span></span>

</li>
</ul>

</li>
<li> At any virtual FF-A instance, if the endpoint is running in EL1 or S-EL1 in either Execution state,
          the permission specified by the Lender is considered valid only if it is the same or less permissive
          than the permission used by the Relayer in the S2AP (RW permissions) field in the stage 2 translation 
          table descriptors for the memory region in one of the following translation regimes:
<ul class="doclist">
<li> Secure EL1&amp;0 translation regime, when S-EL2 is enabled.

</li>
<li> Non-secure EL1&amp;0 translation regime, when EL2 is enabled.

</li>
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">S2AP</span></span> <span class="inlinecode"><span class="id" title="var">should</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">modeled</span></span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" title="var">It</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">about</span></span> <span class="inlinecode"><span class="id" title="var">read</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" title="var">write</span></span> <span class="inlinecode"><span class="id" title="var">permissions</span></span>

</li>
</ul>

</li>
</ul>
        – At the Secure virtual FF-A instance, if the endpoint is running in S-EL0 in either Execution state,
          the permission specified by the Lender is considered valid only if it is the same or less permissive
          than the permission used by the Relayer in the AP(1) field in the stage 1 translation table descriptors
          for the memory region in one of the following translation regimes:
<ul class="doclist">
<li> Secure EL1&amp;0 translation regime, when EL2 is disabled.

</li>
<li> Secure PL1&amp;0 translation regime, when EL2 is disabled.

</li>
<li> Secure EL2&amp;0 translation regime, when Armv8.1-VHE is enabled.

</li>
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">AP</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">Stage</span></span> <span class="inlinecode">1</span> <span class="inlinecode"><span class="id" title="var">should</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">modeled</span></span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" title="var">It</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">about</span></span> <span class="inlinecode"><span class="id" title="var">read</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" title="var">write</span></span> <span class="inlinecode"><span class="id" title="var">permissions</span></span>

</li>
</ul>
          If the Borrower is an independent peripheral device, then the validated permission is used to map the
          memory region into the address space of the device.
<ul class="doclist">
<li> The Borrower (if a PE or Proxy endpoint) should specify the level of access that it would like to have on
          the memory region.

<div class="paragraph"> </div>

          In a transaction to share or lend memory with more than one Borrower, 
          each Borrower (if a PE or Proxy endpoint) could also specify the level of access that other 
          Borrowers have on the memory region.

<div class="paragraph"> </div>

          This is done while invoking the FFA_MEM_RETRIEVE_REQ ABI.

</li>
<li> The Relayer must validate the permissions, if specified by the Borrower (if a PE or Proxy endpoint) in
          response to an invocation of the FFA_MEM_RETRIEVE_REQ ABI.

<div class="paragraph"> </div>

          It must ensure that the permission of the Borrower is the same or less permissive than the permission
          that was specified by the Lender and validated by the Relayer.

<div class="paragraph"> </div>

          It must ensure that the permissions for other Borrowers are the same as those specified by the Lender
          and validated by the Relayer. The Relayer must return the DENIED error code if the validation fails.

</li>
</ul>

</li>
</ul>
   
<div class="paragraph"> </div>


<div class="paragraph"> </div>

     Restrictions in dontate memory: 
<ul class="doclist">
<li> Whether the Owner is allowed to specify the level of access that the Receiver is permitted to have on the
       memory region depends on the type of Receiver.
       – If the Receiver is a PE or Proxy endpoint, the Owner must not specify the level of access.
       – If the Receiver is an independent peripheral device, the Owner could specify the level of access.
       The Owner must specify its choice in an invocation of the FFA_MEM_DONATE ABI.

</li>
<li> The value of data access permission field specified by the Owner must be interpreted by the Relayer as
       follows. This is done in response to an invocation of the FFA_MEM_DONATE ABI.
       – If the Receiver is a PE or Proxy endpoint, the Relayer must return INVALID_PARAMETERS if the
         value is not b00.
       – If the Receiver is an independent peripheral device and the value is not b00, the Relayer must take
         one of the following actions.
<ul class="doclist">
<li> Return DENIED if the permission is determined to be invalid through an IMPLEMENTATION DEFINED mechanism.

</li>
<li> Use the permission specified by the Owner to map the memory region into the address space of the device.

</li>
</ul>

</li>
<li> If the Receiver is an independent peripheral device and the value is b00, the Relayer must determine
         the permission value through an IMPLEMENTATION DEFINED mechanism.

</li>
<li> The Receiver (if a PE or Proxy endpoint) should specify the level of access that it would like to have on
       the memory region. This is done while invoking the FFA_MEM_RETRIEVE_REQ ABI.

</li>
<li> The Relayer must validate the permission specified by the Receiver to ensure that it is the same or less
       permissive than the permission determined by the Relayer through an IMPLEMENTATION DEFINED
       mechanism. This is done in response to an invocation of the FFA_MEM_RETRIEVE_REQ ABI. The
       Relayer must return the DENIED error code if the validation fails.

<div class="paragraph"> </div>

      Restrictions in retrieve response:
<ul class="doclist">
<li> The Relayer must specify the permission that was used to map the memory region in the translation regime
        of the Receiver or Borrower. This must be done in an invocation of the FFA_MEM_RETRIEVE_RESP ABI.

<div class="paragraph"> </div>


</li>
</ul>
      Restrictions on reclaim:
<ul class="doclist">
<li> In a transaction to relinquish memory that was lent to one or more Borrowers, the memory region must be
        mapped back into the translation regime of the Lender with the same data access permission that was used
        at the start of the transaction to lend the memory region. This is done in response to an invocation of the
        FFA_MEM_RECLAIM ABI.

</li>
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">We</span></span> <span class="inlinecode"><span class="id" title="var">need</span></span> <span class="inlinecode"><span class="id" title="var">a</span></span> <span class="inlinecode"><span class="id" title="var">way</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">store</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">previous</span></span> <span class="inlinecode"><span class="id" title="var">permissions</span></span> 

</li>
</ul>

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab60"></a><h4 class="section">Access permission checker</h4>
 Definitions to check access permissions.

<div class="paragraph"> </div>

      Summarized rules (LEND and SHARE) 
<ul class="doclist">
<li> The Relayer must validate the permission specified by the Lender

</li>
<li> the permission specified by the Lender is considered valid only if it is the same or less permissive
        than the permission used by the Relayer in the S2AP (RW permissions) field in the stage 2 translation 
        table descriptors for the memory region

</li>
<li> the permission of the Borrower is the same or less permissive than the permission
        that was specified by the Lender and validated by the Relayer

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">It</span></span> <span class="inlinecode"><span class="id" title="var">does</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">mention</span></span> <span class="inlinecode"><span class="id" title="var">that</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">Relayer</span></span> <span class="inlinecode"><span class="id" title="var">check</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">premissions</span></span> <span class="inlinecode"><span class="id" title="keyword">of</span></span> <span class="inlinecode"><span class="id" title="var">Borrowers</span>.</span> <span class="inlinecode"><span class="id" title="var">I</span></span> <span class="inlinecode"><span class="id" title="var">assume</span></span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="var">will</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">checked</span></span>
        <span class="inlinecode"><span class="id" title="var">during</span></span> <span class="inlinecode"><span class="id" title="var">retrieve</span></span> 

</li>
</ul>

<div class="paragraph"> </div>

      Summarized rules (DONATE)
<ul class="doclist">
<li> If the Receiver is a PE or Proxy endpoint, the Relayer must return INVALID_PARAMETERS if the
        value is not b00.

</li>
<li> The Receiver (if a PE or Proxy endpoint) should specify the level of access that it would like to have on
        the memory region. This is done while invoking the FFA_MEM_RETRIEVE_REQ ABI.

</li>
<li> The Relayer must validate the permission specified by the Receiver to ensure that it is the same or less
        permissive than the permission determined by the Relayer through an IMPLEMENTATION DEFINED
        mechanism. This is done in response to an invocation of the FFA_MEM_RETRIEVE_REQ ABI. The
        Relayer must return the DENIED error code if the validation fails.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab61"></a><h4 class="section">Well formed conditions</h4>
 I added the following checkers, but some of them may not be used due to the redundancy  Returns DENIED, when it returns false 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">data_permissions_lend_and_share_lender_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span> <span class="id" title="var">global</span> <span class="id" title="var">lender</span>: <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">data_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access_permissive</span> <span class="id" title="var">lender</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
</div>

<div class="doc">
When it is not satisfied, the spec needs to return INVALID_PARAMETER  Return INVALID_PARAMETER when it returns false 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">data_permissions_check_donate_lender_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span> <span class="id" title="var">global</span> <span class="id" title="var">lender</span>: <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_NOT_SPECIFIED</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">data_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">data_access_permissive</span> <span class="id" title="var">lender</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER when it returns false 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">data_permissions_borrower_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">data_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">This</span></span> <span class="inlinecode"><span class="id" title="var">does</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">specify</span></span> <span class="inlinecode"><span class="id" title="var">which</span></span> <span class="inlinecode"><span class="id" title="var">we</span></span> <span class="inlinecode"><span class="id" title="var">have</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">store</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">resp</span>.</span> 
<div class="paragraph"> </div>

<a name="lab62"></a><h3 class="section">5.11.3 Instruction access permissions usage</h3>
 <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="var">following</span></span> <span class="inlinecode"><span class="id" title="var">things</span></span> <span class="inlinecode"><span class="id" title="var">need</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">implemented</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">transition</span></span> <span class="inlinecode"><span class="id" title="var">rules</span></span>

<div class="paragraph"> </div>

      An endpoint could have either Execute (X) or Execute-never (XN) instruction access permission to a memory
      region from the highest Exception level it runs in.
<ul class="doclist">
<li> Execute permission is more permissive than Execute-never permission.

</li>
<li> Instruction access permission is specified by setting Bits(3:2) in Table 5.15 to the appropriate value.

</li>
</ul>
      This access control is used in memory management transactions as follows.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Only XN permission must be used in the following transactions.
<ul class="doclist">
<li> In a transaction to share memory with one or more Borrowers.

</li>
<li> In a transaction to lend memory to more than one Borrower.

</li>
</ul>
         Bits(3:2) in Table 5.15 must be set to b00 as follows.
<ul class="doclist">
<li> By the Lender in an invocation of FFA_MEM_SHARE or FFA_MEM_LEND ABIs.

</li>
<li> By the Borrower in an invocation of the FFA_MEM_RETRIEVE_REQ ABI.

</li>
</ul>
         The Relayer must set Bits(3:2) in Table 5.15 to b01 while invoking the FFA_MEM_RETRIEVE_RESP ABI.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab63"></a><h4 class="section">Well formed conditions</h4>
 <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">specified</span>,</span> <span class="inlinecode"><span class="id" title="var">but</span></span> <span class="inlinecode"><span class="id" title="keyword">return</span></span> <span class="inlinecode"><span class="id" title="var">INVALID_PARAMETER</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="var">returns</span></span> <span class="inlinecode"><span class="id" title="var">false</span></span>  Return INVALID_PARAMETER when it is not specified 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_share_and_lend_multiple_borrower_lender_descriptor_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NOT_SPECIFIED</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>  =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">specified</span>,</span> <span class="inlinecode"><span class="id" title="var">but</span></span> <span class="inlinecode"><span class="id" title="keyword">return</span></span> <span class="inlinecode"><span class="id" title="var">DENIED</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="var">returns</span></span> <span class="inlinecode"><span class="id" title="var">false</span></span>  Return DENIED when it is not specified 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_share_and_lend_multiple_borrower_lender_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">lender</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lender</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">lender</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">specified</span>,</span> <span class="inlinecode"><span class="id" title="var">but</span></span> <span class="inlinecode"><span class="id" title="keyword">return</span></span> <span class="inlinecode"><span class="id" title="var">INVALID_PARAMETER</span></span> <span class="inlinecode"><span class="id" title="var">when</span></span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="var">returns</span></span> <span class="inlinecode"><span class="id" title="var">false</span></span> <span class="inlinecode"></span> Return DENIED when it is not specified 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_share_and_lend_multiple_borrower_borrower_descriptor_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NOT_SPECIFIED</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
for resp's descriptor - FFA_MEM_SHARE and FFA_MEM_LEND for multiple borrowers  Return INVALID_PARAMETER when it is not specified 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_share_and_lend_multiple_borrower_resp_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<ul class="doclist">
<li> In a transaction to donate memory or lend memory to a single Borrower,
<ul class="doclist">
<li> Whether the Owner/Lender is allowed to specify the level of access that the Receiver is permitted to
           have on the memory region depends on the type of Receiver.
<ul class="doclist">
<li> If the Receiver is a PE or Proxy endpoint, the Owner must not specify the level of access.

</li>
<li> If the Receiver is an independent peripheral device, the Owner could specify the level of access.

</li>
</ul>
           The Owner must specify its choice in an invocation of the FFA_MEM_DONATE or FFA_MEM_LEND ABIs.

</li>
<li> The value of instruction access permission field specified by the Owner/Lender must be interpreted   
           by the Relayer as follows. This is done in response to an invocation of the
           FFA_MEM_DONATE or FFA_MEM_LEND ABIs.
<ul class="doclist">
<li> If the Receiver is a PE or Proxy endpoint, the Relayer must return INVALID_PARAMETERS if the 
             value is not b00.

</li>
<li> If the Receiver is an independent peripheral device and the value is not b00, the Relayer must take 
             one of the following actions.
<ul class="doclist">
<li> Return DENIED if the permission is determined to be invalid through an IMPLEMENTATION DEFINED mechanism.

</li>
<li> Use the permission specified by the Owner to map the memory region into the address space of the device.

</li>
</ul>

</li>
<li> If the Receiver is an independent peripheral device and the value is b00, the Relayer must determine 
             the permission value through an IMPLEMENTATION DEFINED mechanism.

</li>
</ul>

</li>
<li> The Receiver (if a PE or Proxy endpoint) should specify the level of access that it would like to 
           have on the memory region. This must be done in an invocation of the FFA_MEM_RETRIEVE_REQ ABI.

</li>
<li> The Relayer must validate the permission specified by the Receiver (if a PE or Proxy endpoint) to
           ensure that it is the same or less permissive than the permission determined by the Relayer through an       
           IMPLEMENTATION DEFINED mechanism.
<ul class="doclist">
<li> For example, the Relayer could deny executable access to a Borrower on a memory region of Device
             memory type.

</li>
</ul>
           This is done in response to an invocation of the FFA_MEM_RETRIEVE_REQ ABI. The Relayer must
           return the DENIED error code if the validation fails.

<div class="paragraph"> </div>

           If the invocation of FFA_MEM_RETRIEVE_REQ succeeds, the Relayer must set Bits(3:2) in Table
           5.15 to either b01 or b10 while invoking the FFA_MEM_RETRIEVE_RESP ABI.

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> In a transaction to relinquish memory that was lent to one or more Borrowers, the memory region must be
        mapped back into the translation regime of the Lender with the same instruction access permission that was
        used at the start of the transaction to lend the memory region. This is done in response to an 
        invocation of the FFA_MEM_RECLAIM ABI.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab64"></a><h4 class="section">Well formed conditions</h4>
 for borower's descriptor - FFA_MEM_DONATE and FFA_MEM_LEND for single borrowers  Return INVALID_PARAMETER when it returns false 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_donate_and_lend_single_borrower_lender_descriptor_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NOT_SPECIFIED</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
for borower's descriptor - FFA_MEM_DONATE and FFA_MEM_LEND for single borrowers  Return DENIED when it returns false 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_donate_and_lend_single_borrower_lender_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">lender</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">lender</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
</div>

<div class="doc">
When it is not satisfied, the spec needs to return DENIED  Return DENIED when it is not possible 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_donate_and_lend_single_borrower_borrower_descriptor_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER when it is not possible 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">instruction_permissions_donate_and_lend_single_borrower_resp_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">global</span> <span class="id" title="var">descriptor</span> <span class="id" title="var">borrower</span>: <span class="id" title="var">FFA_INSTRUCTION_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">borrower</span>, <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_INSTRUCTION_ACCESS_NX</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_INSTRUCTION_ACCESS_X</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">instruction_access_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">borrower</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab65"></a><h3 class="section">5.11.4 Memory region attributes usage</h3>
 Memory type : Device-nGnRnE &lt; Device-nGnRE &lt; Device-nGRE &lt; Device-GRE &lt; Normal.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Cacheability attribute : Non-cacheable &lt; Write-Back Cacheable.

</li>
<li> Shareability attribute : Non-Shareable &lt; Inner Shareable &lt; Outer shareable. 
</li>
</ul>

<div class="paragraph"> </div>

      An endpoint can access a memory region by specifying attributes as follows.
<ul class="doclist">
<li> Memory type. This could be Device or Normal. Device memory type could be one of the following types.
<ul class="doclist">
<li> Device-nGnRnE.

</li>
<li> Device-nGnRE.

</li>
<li> Device-nGRE.

</li>
<li> Device-GRE.

</li>
</ul>
        The precedence rules for memory types are as follows. &lt; should be read as is less permissive than.
<ul class="doclist">
<li> Device-nGnRnE &lt; Device-nGnRE &lt; Device-nGRE &lt; Device-GRE &lt; Normal.

</li>
</ul>

</li>
<li> Cacheability attribute. This could be one of the following types.
<ul class="doclist">
<li> Non-cacheable.

</li>
<li> Write-Back Cacheable.

</li>
</ul>
        These attributes are used to specify both inner and outer cacheability. The precedence rules are as follows.
<ul class="doclist">
<li> Non-cacheable &lt; Write-Back Cacheable.

</li>
</ul>

</li>
<li> Shareability attribute. This could be one of the following types.
<ul class="doclist">
<li> Non-shareable.

</li>
<li> Outer Shareable.

</li>
<li> Inner Shareable.

</li>
</ul>
        The precedence rules are as follows.
<ul class="doclist">
<li> Non-Shareable &lt; Inner Shareable &lt; Outer shareable.

</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

      Memory region attributes are specified by an endpoint by setting Bits<span class="inlinecode">5:0</span> in Table 5.18 to appropriate values.
      The data structure to encode memory region attributes is specified in Table 5.18.
   
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_1</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_RESERVED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_NON_CACHEABLE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_RESERVED_1</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_WRITE_BACK</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_2</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGNRNE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGNRE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGRE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_GRE</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_MEMORY_SHAREABILITY</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_SHARE_NON_SHAREABLE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_SHARE_RESERVED</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_OUTER_SHAREABLE</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_INNER_SHAREABLE</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_1_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">a</span> <span class="id" title="var">b</span>: <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_1</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">a</span>, <span class="id" title="var">b</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_WRITE_BACK</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_CACHE_WRITE_BACK</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_WRITE_BACK</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_CACHE_NON_CACHEABLE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_NON_CACHEABLE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_CACHE_NON_CACHEABLE</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_CACHE_NON_CACHEABLE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_CACHE_WRITE_BACK</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_2_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">a</span> <span class="id" title="var">b</span>: <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_2</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">a</span>, <span class="id" title="var">b</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_GRE</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGRE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_DEV_GRE</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGRE</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGNRE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_DEV_GRE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGNRE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_DEV_NGRE</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGNRE</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEV_NGNRNE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_DEV_NGNRNE</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEMORY_SHAREABILITY_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">a</span> <span class="id" title="var">b</span> : <span class="id" title="var">FFA_MEMORY_SHAREABILITY</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">a</span>, <span class="id" title="var">b</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_OUTER_SHAREABLE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_SHARE_RESERVED</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_OUTER_SHAREABLE</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_INNER_SHAREABLE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_INNER_SHAREABLE</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_INNER_SHAREABLE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_SHARE_NON_SHAREABLE</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_INNER_SHAREABLE</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_SHARE_NON_SHAREABLE</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_SHARE_NON_SHAREABLE</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_MEMORY_TYPE</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_NOT_SPECIFIED_MEM</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEVICE_MEM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cacheability_type</span>: <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_2</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_NORMAL_MEM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">cacheability_type</span>: <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">shareability_type</span>: <span class="id" title="var">FFA_MEMORY_SHAREABILITY</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_MEM_RESERVED</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_MEMORY_TYPE_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">a</span> <span class="id" title="var">b</span> : <span class="id" title="var">FFA_MEMORY_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">a</span>, <span class="id" title="var">b</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_DEVICE_MEM</span> <span class="id" title="var">cacheability_type_a</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_DEVICE_MEM</span> <span class="id" title="var">cacheability_type_b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&gt; <span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_2_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cacheability_type_a</span> <span class="id" title="var">cacheability_type_b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_NORMAL_MEM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cacheability_type_a</span> <span class="id" title="var">shareability_type_a</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_NORMAL_MEM</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cacheability_type_b</span> <span class="id" title="var">shareability_type_b</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_CACHEABILITY_TYPE_1_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">cacheability_type_a</span> <span class="id" title="var">cacheability_type_b</span> &amp;&amp; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_SHAREABILITY_permissive</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">shareability_type_a</span> <span class="id" title="var">shareability_type_b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span>, <span class="id" title="var">_</span> =&gt; <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab66"></a><h4 class="section">FFA Memory Region Attributes Descriptor Coq definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_memory_region_attributes_descriptor_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_region_attributes_descriptor_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> bits(7:6): Reserved (MBZ).
<ul class="doclist">
<li> bits(5:4): Memory type.
<ul class="doclist">
<li> b00: Not specified and must be ignored.

</li>
<li> b01: Device memory.

</li>
<li> b10: Normal memory.

</li>
<li> b11: Reserved. Must not be used.

</li>
</ul>

</li>
<li> bits(3:2):
<ul class="doclist">
<li> Cacheability attribute if bit(5:4) = b10.
<ul class="doclist">
<li> b00: Reserved. Must not be used.

</li>
<li> b01: Non-cacheable.

</li>
<li> b10: Reserved. Must not be used.

</li>
<li> b11: Write-Back.

</li>
</ul>

</li>
<li> Device memory attributes if bit(5:4) = b01.
<ul class="doclist">
<li> b00: Device-nGnRnE.

</li>
<li> b01: Device-nGnRE.

</li>
<li> b10: Device-nGRE.

</li>
<li> b11: Device-GRE. 

</li>
</ul>

</li>
</ul>

</li>
<li> bits(1:0):
<ul class="doclist">
<li> Shareability attribute if bit(5:4) = b10.
<ul class="doclist">
<li> b00: Non-shareable.

</li>
<li> b01: Reserved. Must not be used.

</li>
<li> b10: Outer Shareable.

</li>
<li> b11: Inner Shareable.

</li>
</ul>

</li>
<li> Reserved &amp; MBZ if bit(5:4) = b01. 
</li>
</ul>

</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_attributes_descriptor_struct_memory_type</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_TYPE</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_memory_region_attributes_descriptor_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_region_attributes_descriptor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_NOT_SPECIFIED_MEM</span>.<br/>

<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="var">following</span></span> <span class="inlinecode"><span class="id" title="var">things</span></span> <span class="inlinecode"><span class="id" title="var">need</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">implemented</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">transition</span></span> <span class="inlinecode"><span class="id" title="var">rules</span></span> 

<div class="paragraph"> </div>

      Memory region attributes are used in memory management transactions as follows.

<div class="paragraph"> </div>

<ul class="doclist">
<li> In a transaction to share memory with one or more Borrowers and to lend memory to more than one Borrower,
<ul class="doclist">
<li> The Lender specifies the attributes that each Borrower must access the memory region with. This is
          done by invoking the FFA_MEM_SHARE or FFA_MEM_LEND ABIs. The same attributes are used for
          all Borrowers.

</li>
<li> The Relayer validates the attributes specified by the Lender as follows. This is done in response to an
          invocation of the FFA_MEM_SHARE or FFA_MEM_LEND ABIs. The Relayer must return the DENIED
          error code if the validation fails.
<ul class="doclist">
<li> At the Non-secure physical FF-A instance, an IMPLEMENTATION DEFINED mechanism is used.

</li>
<li> At any virtual FF-A instance, if the endpoint is running in EL1 or S-EL1 in either Execution state,
            the attributes specified by the Lender are considered valid only if they are the same or less permissive
            than the attributes used by the Relayer in the stage 2 translation table descriptors for the memory
            region in one of the following translation regimes:
<ul class="doclist">
<li> Secure EL1&amp;0 translation regime, when S-EL2 is enabled.

</li>
<li> Non-secure EL1&amp;0 translation regime, when EL2 is enabled.

</li>
</ul>

</li>
<li> At the Secure virtual FF-A instance, if the endpoint is running in S-EL0 in either Execution state,
            the attributes specified by the Lender are considered valid only if they are either the same or less
            permissive than the attributes used by the Relayer in the stage 1 translation table descriptors for the
            memory region in one of the following translation regimes:
<ul class="doclist">
<li> Secure EL1&amp;0 translation regime, when EL2 is disabled.

</li>
<li> Secure PL1&amp;0 translation regime, when EL2 is disabled.

</li>
<li> Secure EL2&amp;0 translation regime, when Armv8.1-VHE is enabled.

</li>
</ul>

</li>
</ul>
          If the Borrower is an independent peripheral device, then the validated attributes are used to map the
          memory region into the address space of the device.

</li>
<li> The Borrower (if a PE or Proxy endpoint) should specify the attributes that it would like to access the
          memory region with. This is done by invoking the FFA_MEM_RETRIEVE_REQ ABI.

</li>
<li> The Relayer must validate the attributes specified by the Borrower (if a PE or Proxy endpoint) to ensure
          that they are the same or less permissive than the attributes that were specified by the Lender and
          validated by the Relayer. This is done in response to an invocation of the FFA_MEM_RETRIEVE_REQ
          ABI. The Relayer must return the DENIED error code if the validation fails.

</li>
</ul>

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab67"></a><h4 class="section">Well formed conditions</h4>
 Return DENIED when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">attributes_share_and_multiple_borrowers_lender_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span> <span class="id" title="var">lender</span> <span class="id" title="var">global</span> : <span class="id" title="var">FFA_MEMORY_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">FFA_MEMORY_TYPE_permissive</span> <span class="id" title="var">lender</span> <span class="id" title="var">descriptor</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_TYPE_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_MEMORY_TYPE_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">lender</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
</div>

<div class="doc">
Return DENIED when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">attributes_share_and_multiple_borrowers_borrower_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span> <span class="id" title="var">global</span> : <span class="id" title="var">FFA_MEMORY_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">FFA_MEMORY_TYPE_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
</div>

<div class="doc">
<ul class="doclist">
<li> In a transaction to donate memory or lend memory to a single Borrower,
<ul class="doclist">
<li> Whether the Owner/Lender is allowed to specify the memory region attributes that the Receiver must
          use to access the memory region depends on the type of Receiver.
<ul class="doclist">
<li> If the Receiver is a PE or Proxy endpoint, the Owner must not specify the attributes.

</li>
<li> If the Receiver is an independent peripheral device, the Owner could specify the attributes.

</li>
</ul>
          The Owner must specify its choice in an invocation of the FFA_MEM_DONATE or FFA_MEM_LEND ABIs.

</li>
<li> The values in the memory region attributes field specified by the Owner/Lender must be interpreted
          by the Relayer as follows. This is done in response to an invocation of the FFA_MEM_DONATE or
          FFA_MEM_LEND ABIs.
<ul class="doclist">
<li> If the Receiver is a PE or Proxy endpoint, the Relayer must return INVALID_PARAMETERS if the
            value in bits(5:4) != b00.

</li>
<li> If the Receiver is an independent peripheral device and the value is not b00, the Relayer must take
            one of the following actions.
<ul class="doclist">
<li> Return DENIED if the attributes are determined to be invalid through an IMPLEMENTATION
              DEFINED mechanism.

</li>
<li> Use the attributes specified by the Owner to map the memory region into the address space of the
              device.

</li>
</ul>

</li>
<li> If the Receiver is an independent peripheral device and the value is b00, the Relayer must determine
            the attributes through an IMPLEMENTATION DEFINED mechanism.

</li>
</ul>

</li>
<li> The Receiver (if a PE or Proxy endpoint) should specify the memory region attributes it would like to
          use to access the memory region. This is done while invoking the FFA_MEM_RETRIEVE_REQ ABI.

</li>
<li> The Relayer must validate the attributes specified by the Receiver (if a PE or Proxy endpoint) to ensure
          that they are the same or less permissive than the attributes determined by the Relayer through an
          IMPLEMENTATION DEFINED mechanism.

<div class="paragraph"> </div>

          This is done in response to an invocation of the FFA_MEM_RETRIEVE_REQ ABI. The Relayer must
          return the DENIED error code if the validation fails.

<div class="paragraph"> </div>


</li>
<li> The Relayer must specify the memory region attributes that were used to map the memory region
          in the translation regime of the Receiver or Borrower. This must be done while invoking the
          FFA_MEM_RETRIEVE_RESP ABI.

<div class="paragraph"> </div>


</li>
<li> In a transaction to relinquish memory that was lent to one or more Borrowers, the memory region must be
          mapped back into the translation regime of the Lender with the same attributes that were used at the start of the
          transaction to lend the memory region. This is done in response to an invocation of the FFA_MEM_RECLAIM ABI.

</li>
</ul>

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab68"></a><h4 class="section">Well formed conditions</h4>
 Return INVALID_PARAMETERS when it is not statisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">attributes_donate_and_single_borrower_lender_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span> <span class="id" title="var">lender</span> <span class="id" title="var">global</span> : <span class="id" title="var">FFA_MEMORY_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">descriptor</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEMORY_NOT_SPECIFIED_MEM</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">FFA_MEMORY_TYPE_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">lender</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Return DENIED when it is not statisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">attributes_donate_and_single_borrower_borrower_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">descriptor</span> <span class="id" title="var">global</span> : <span class="id" title="var">FFA_MEMORY_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">FFA_MEMORY_TYPE_permissive</span> <span class="id" title="var">global</span> <span class="id" title="var">descriptor</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_DESCRIPTIONS</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab69"></a><h1 class="section">transaction descriptors</h1>

</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_MEMORY_REGION_DESCRIPTOR</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Context</span> `{<span class="id" title="var">ffa_types_and_constants</span>: <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span>}.<br/>
</div>

<div class="doc">
<a name="lab70"></a><h2 class="section">5.12 Lend, donate, and share transaction descriptor</h2>

<div class="paragraph"> </div>

<a name="lab71"></a><h3 class="section">5.12.4 Flags usage</h3>

<div class="paragraph"> </div>

 This flag should be defined before defining <span class="inlinecode"><span class="id" title="var">ffa_memory_region</span></span> <span class="inlinecode"><span class="id" title="var">descriptor</span></span>

<div class="paragraph"> </div>

<ul class="doclist">
<li> Flags are used to govern the behavior of a memory management transaction.

<div class="paragraph"> </div>


</li>
<li> Usage of the Flags field in an invocation of the following ABIs is specified in Table 5.20.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>

</li>
<li> Usage of the Flags field in an invocation of the FFA_MEM_RETRIEVE_REQ ABI is specified in Table 5.21.

</li>
<li> Usage of the Flags field in an invocation of the FFA_MEM_RETRIEVE_RESP ABI is specified in Table 5.22.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab72"></a><h4 class="section">Zero memory flag</h4>

      In some ABI invocations, the caller could set a 
      flag to request the Relayer to zero a memory region. To do this, the Relayer must:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Map the memory region in its translation regime once it is not mapped in the translation regime of any other 

</li>
</ul>
       FF-A component.

<div class="paragraph"> </div>

       The caller must ensure that the memory region fulfills the size and alignment requirements listed in 2.7
       Memory granularity and alignment to allow the Relayer to map this memory region. It must discover these
       requirements by invoking the FFA_FEATURES interface with the function ID of the FFA_RXTX_MAP
       interface (see 8.2 FFA_FEATURES).

<div class="paragraph"> </div>

       The Relayer must return INVALID_PARAMETERS if the memory region does not meet these requirements.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Zero the memory region and perform cache maintenance such that the memory regions contents are coherent
         between any PE caches, system caches and system memory.

</li>
<li> Unmap the memory region from its translation regime before it is mapped in the translation regime of any
         other FF-A component.

</li>
</ul>
   
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>, <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span>, and <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span>

<div class="paragraph"> </div>

      Table 5.20: Flags usage in <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>, <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span> and <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span> ABIs 
</div>
<div class="code">

<br/>
</div>

<div class="doc">
<a name="lab73"></a><h4 class="section">FFA Mem Default Flags</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_mem_default_flags_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_mem_default_flags_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(0): Zero memory flag.
<ul class="doclist">
<li> In an invocation of FFA_MEM_DONATE or FFA_MEM_LEND, this flag specifies
                if the memory region contents must be zeroed by the Relayer after the memory
                region has been unmapped from the translation regime of the Owner.
<ul class="doclist">
<li> b0: Relayer must not zero the memory region contents.

</li>
<li> b1: Relayer must zero the memory region contents.

</li>
</ul>

</li>
<li> MBZ in an invocation of FFA_MEM_SHARE, else the Relayer must return INVALID_PARAMETERS.

</li>
<li> MBZ if the Owner has Read-only access to the memory region , else the Relayer must return DENIED. 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_default_flags_struct_zero_memory_flag</span>: <span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(1): Operation time slicing flag.
<ul class="doclist">
<li> In an invocation of FFA_MEM_DONATE, FFA_MEM_LEND or
                FFA_MEM_SHARE, this flag specifies if the Relayer can time slice this operation.
<ul class="doclist">
<li> b0: Relayer must not time slice this operation.

</li>
<li> b1: Relayer can time slice this operation.

</li>
</ul>

</li>
<li>  MBZ if the Relayer does not support time slicing of memory management
                 operations (see 12.2.3 Time slicing of memory management operations), else the
                 Relayer must return INVALID_PARAMETERS. 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_default_flags_struct_operation_time_slicing_flag</span>: <span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(31:2): Reserved (MBZ). 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab74"></a><h4 class="section">Well formed conditions</h4>
 Return INVALID_PARAMETER or DENIED when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_FFA_mem_default_flags_struct_for_donate_and_lend</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">default_flag</span>: <span class="id" title="var">FFA_mem_default_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">data_access</span> : <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">time_slice_enabled</span> : <span class="id" title="var">bool</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">time_slice_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_operation_time_slicing_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_enabled</span> <span class="id" title="keyword">then</span> <span class="id" title="var">false</span> <span class="id" title="keyword">else</span> <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_check</span> <span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_zero_memory_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">match</span> <span class="id" title="var">data_access</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_FFA_mem_default_flags_struct_for_share</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">default_flag</span>: <span class="id" title="var">FFA_mem_default_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">time_slice_enabled</span> : <span class="id" title="var">bool</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">time_slice_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_operation_time_slicing_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_enabled</span> <span class="id" title="keyword">then</span> <span class="id" title="var">false</span> <span class="id" title="keyword">else</span> <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_check</span> <span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_zero_memory_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>
</div>

<div class="doc">
<a name="lab75"></a><h4 class="section">Well formed conditions for retrieve (when it is not using retrieve flags</h4>
 Return INVALID_PARAMETER or DENIED when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_FFA_mem_default_flags_struct_for_donate_and_lend_retrieve</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">default_flag</span>: <span class="id" title="var">FFA_mem_default_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">time_slice_enabled</span> : <span class="id" title="var">bool</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">time_slice_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_operation_time_slicing_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_enabled</span> <span class="id" title="keyword">then</span> <span class="id" title="var">false</span> <span class="id" title="keyword">else</span> <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_check</span> <span class="id" title="keyword">then</span> <span class="id" title="var">None</span>      <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER when it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_FFA_mem_default_flags_struct_for_share_retrieve</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">default_flag</span>: <span class="id" title="var">FFA_mem_default_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">time_slice_enabled</span> : <span class="id" title="var">bool</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">time_slice_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_operation_time_slicing_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_enabled</span> <span class="id" title="keyword">then</span> <span class="id" title="var">false</span> <span class="id" title="keyword">else</span> <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_check</span> <span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">default_flag</span>.(<span class="id" title="var">FFA_mem_default_flags_struct_zero_memory_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>

<br/>
</div>

<div class="doc">
FFA_MEM_RETRIEVE_REQ 
      Table 5.21: Flags usage in FFA_MEM_RETRIEVE_REQ ABI 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFA_memory_management_transaction_type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_DEFAULT_TRANSACTION</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_SHARE_TRANSACTION</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_LEND_TRANSACTION</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_DONATE_TRANSACTION</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab76"></a><h4 class="section">FFA Mem Relinquish Req Flags Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_mem_relinquish_req_flags_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(0): Zero memory before retrieval flag.
              – In an invocation of FFA_MEM_RETRIEVE_REQ, during a transaction to lend or donate memory, 
                this flag is used by the Receiver to specify whether the memory
                region must be retrieved with or without zeroing its contents first.
<ul class="doclist">
<li> b0: Retrieve the memory region irrespective of whether the Sender requested
                  the Relayer to zero its contents prior to retrieval.

</li>
<li> b1: Retrieve the memory region only if the Sender requested the Relayer to
                  zero its contents prior to retrieval by setting the Bit<span class="inlinecode">0</span> in Table 5.20).

</li>
</ul>

</li>
<li> MBZ in a transaction to share a memory region, else the Relayer must return
                INVALID_PARAMETER.

</li>
<li> If the Sender has Read-only access to the memory region and the Receiver sets
                Bit(0), the Relayer must return DENIED.

</li>
<li> MBZ if the Receiver has previously retrieved this memory region, else the Relayer
                must return INVALID_PARAMETERS (see 11.4.2 Support for multiple retrievals by
                a Borrower). 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_zero_memory_before_retrieval_flag</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(1): Operation time slicing flag.
              – In an invocation of FFA_MEM_RETRIEVE_REQ, this flag specifies if the Relayer can time slice this operation.
<ul class="doclist">
<li> b0: Relayer must not time slice this operation.

</li>
<li> b1: Relayer can time slice this operation.

</li>
</ul>

</li>
<li> MBZ if the Relayer does not support time slicing of memory management
                operations (see 12.2.3 Time slicing of memory management operations), else the
                Relayer must return INVALID_PARAMETERS. 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_operation_time_slicing_flag</span>: <span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">This</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="var">has</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">reflected</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">our</span></span> <span class="inlinecode"><span class="id" title="var">spec</span></span>
<ul class="doclist">
<li> Bit(2): Zero memory after relinquish flag.
              – In an invocation of FFA_MEM_RETRIEVE_REQ, this flag specifies whether the Relayer must zero the memory 
                region contents after unmapping it from the translation regime of the Borrower or if the Borrower crashes.
<ul class="doclist">
<li> b0: Relayer must not zero the memory region contents.

</li>
<li> b1: Relayer must zero the memory region contents.

</li>
</ul>
              – If the memory region is lent to multiple Borrowers, the Relayer must clear memory region contents after 
                unmapping it from the translation regime of each Borrower, if any Borrower including the caller sets this flag.
              – This flag could be overridden by the Receiver in an invocation of FFA_MEM_RELINQUISH
                (see Flags field in Table 11.25).
<ul class="doclist">
<li> MBZ if the Receiver has Read-only access to the memory region, else the Relayer must return DENIED. 
                The Receiver could be a PE endpoint or a dependent peripheral device.

</li>
<li> MBZ in a transaction to share a memory region, else the Relayer must return
                INVALID_PARAMETER. 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_zero_memory_after_retrieval_flag</span>: <span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">This</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="var">has</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">reflected</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">our</span></span> <span class="inlinecode"><span class="id" title="var">spec</span></span>
<ul class="doclist">
<li> Bit(4:3): Memory management transaction type flag.
               – In an invocation of FFA_MEM_RETRIEVE_REQ, this flag is used by the Receiver
                 to either specify the memory management transaction it is participating in or indicate
                 that it will discover this information in the invocation of
                 FFA_MEM_RETRIEVE_RESP corresponding to this request.
<ul class="doclist">
<li> b00: Relayer must specify the transaction type in FFA_MEM_RETRIEVE_RESP.

</li>
<li> b01: Share memory transaction.

</li>
<li> b10: Lend memory transaction.

</li>
<li> b11: Donate memory transaction.

</li>
</ul>

</li>
<li> Relayer must return INVALID_PARAMETERS if the transaction type specified by the
                 Receiver is not the same as that specified by the Sender for the memory region
                 identified by the Handle value specified in the transaction descriptor. 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_memory_management_transaction_type_flag</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_management_transaction_type</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(9:5): Address range alignment hint.
              – In an invocation of FFA_MEM_RETRIEVE_REQ, this flag is used by the Receiver to specify the boundary, 
                expressed as multiples of 4KB, to which the address ranges
                allocated by the Relayer to map the memory region must be aligned.
              – Bit(9): Hint valid flag.
<ul class="doclist">
<li> b0: Relayer must choose the alignment boundary. Bits<span class="inlinecode">8:5</span> are reserved and MBZ.

</li>
<li> b1: Relayer must use the alignment boundary specified in Bits(8:5).

</li>
</ul>

</li>
<li> Bit(8:5): Alignment hint.
<ul class="doclist">
<li> If the value in this field is n, then the address ranges must be aligned to the 2*n x 4KB boundary.

</li>
</ul>

</li>
<li> MBZ if the Receiver specifies the IPA or VA address ranges that must be used by the
                Relayer to map the memory region, else the Relayer must return
                INVALID_PARAMETERS.

</li>
<li> Relayer must return DENIED if it is not possible to allocate the address ranges at the
                alignment boundary specified by the Receiver.

</li>
<li> Relayer must return INVALID_PARAMETERS if a reserved value is specified by the Receiver. 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_address_range_alignment_hint</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">bool</span>  * <span class="id" title="var">Z</span>  )%<span class="id" title="keyword">type</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit<span class="inlinecode">31:10</span> - Reserved (MBZ) 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_mem_relinquish_req_flags_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_mem_relinquish_req_flags_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">false</span> <span class="id" title="var">false</span> <span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">MEMORY_MANAGEMENT_DEFAULT_TRANSACTION</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">false</span>, 0).<br/>

<br/>

<br/>
</div>

<div class="doc">
<a name="lab77"></a><h4 class="section">Well formed conditions</h4>
 Return INVALID_PARAMETER or DENIED if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_req_zero_flags_for_donate_and_lend_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">sender_data_access</span> : <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">time_slice_enabled</span> : <span class="id" title="var">bool</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">time_slice_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_operation_time_slicing_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_enabled</span> <span class="id" title="keyword">then</span> <span class="id" title="var">false</span> <span class="id" title="keyword">else</span> <span class="id" title="var">true</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">time_slice_check</span> <span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_zero_memory_before_retrieval_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">match</span> <span class="id" title="var">sender_data_access</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER or DENIED if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_req_zero_after_flags_for_donate_and_lend_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">receiver_data_access</span> : <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_zero_memory_after_retrieval_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">match</span> <span class="id" title="var">receiver_data_access</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_req_zero_flags_for_share_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_zero_memory_after_retrieval_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_req_zero_after_flags_for_share_check</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_zero_memory_after_retrieval_flag</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_req_transaction_type_check</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">function_type</span> : <span class="id" title="var">option</span> <span class="id" title="var">FFA_FUNCTION_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_memory_management_transaction_type_flag</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_DEFAULT_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_SHARE_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_SHARE</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_LEND_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_LEND</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_DONATE_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_DONATE</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
Return DENIED if it is not satisfied <ul class="doclist">
<li> Relayer must return INVALID_PARAMETERS if a reserved value is specified by the Receiver.
        <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">This</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="var">needs</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">dealt</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">transition</span></span> <span class="inlinecode"><span class="id" title="var">rules</span></span> 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_req_alignment_hint_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">address</span> : <span class="id" title="var">Z</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">fst</span> (<span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_address_range_alignment_hint</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">let</span> <span class="id" title="var">alignment</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">snd</span> (<span class="id" title="var">relinquish_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_mem_relinquish_req_flags_struct_address_range_alignment_hint</span>)) <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">decide</span> (0 = <span class="id" title="var">Z.modulo</span> <span class="id" title="var">address</span> (<span class="id" title="var">Z.mul</span> 2 (<span class="id" title="var">Z.mul</span> <span class="id" title="var">alignment</span> 4096))))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>).<br/>

<br/>
</div>

<div class="doc">
FFA_MEM_RETRIEVE_RESP
      Table 5.22: Flags usage in FFA_MEM_RETRIEVE_RESP ABI 
</div>
<div class="code">

<br/>
</div>

<div class="doc">
<a name="lab78"></a><h4 class="section">FFA Mem Relinquish Resp Flags Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_mem_relinquish_resp_flags_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_mem_relinquish_resp_flags_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(0): Zero memory before retrieval flag.
<ul class="doclist">
<li> In an invocation of FFA_MEM_RETRIEVE_RESP during a transaction to lend or
              donate memory, this flag is used by the Relayer to specify whether the memory
              region was retrieved with or without zeroing its contents first.
<ul class="doclist">
<li> b0: Memory region was retrieved without zeroing its contents.

</li>
<li> b1: Memory region was retrieved after zeroing its contents.

</li>
</ul>

</li>
<li> MBZ in a transaction to share a memory region.

</li>
<li> MBZ if the Sender has Read-only access to the memory region. 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">zero_memory_before_retrieval_flag_in_FFA_mem_relinquish_resp_flags_struct</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">bool</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(2:1) - Reserved (MBZ). 

<div class="paragraph"> </div>

<ul class="doclist">
<li> Bit(4:3): Memory management transaction type flag.
              – In an invocation of FFA_MEM_RETRIEVE_RESP, this flag is used by the Relayer
                to specify the memory management transaction the Receiver is participating in.
<ul class="doclist">
<li> b00: Reserved.

</li>
<li> b01: Share memory transaction.

</li>
<li> b10: Lend memory transaction.

</li>
<li> b11: Donate memory transaction.

</li>
</ul>

</li>
</ul>
            
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">memory_management_transaction_type_flag_in_FFA_mem_relinquish_resp_flags_struct</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_management_transaction_type</span>;        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> Bit(31:5) - Reserved (MBZ). 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
</div>

<div class="doc">
<a name="lab79"></a><h4 class="section">Well formed conditions</h4>
 <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="keyword">return</span></span> <span class="inlinecode"><span class="id" title="var">value</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="var">specified</span>,</span> <span class="inlinecode"><span class="id" title="var">but</span></span> <span class="inlinecode"><span class="id" title="var">I</span></span> <span class="inlinecode"><span class="id" title="var">will</span></span> <span class="inlinecode"><span class="id" title="var">follow</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">rule</span></span> <span class="inlinecode"><span class="id" title="var">that</span></span>
      <span class="inlinecode"><span class="id" title="var">previous</span></span> <span class="inlinecode"><span class="id" title="var">flag</span></span> <span class="inlinecode"><span class="id" title="var">checks</span></span> <span class="inlinecode"><span class="id" title="var">use</span></span> <span class="inlinecode"></span> Return INVALID_PARAMETER or DENIED if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_FFA_mem_relinquish_resp_flags_for_donate_and_lend</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_resp_flag</span>: <span class="id" title="var">FFA_mem_relinquish_resp_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">sender_data_access</span> : <span class="id" title="var">FFA_DATA_ACCESS_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_resp_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">zero_memory_before_retrieval_flag_in_FFA_mem_relinquish_resp_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">match</span> <span class="id" title="var">sender_data_access</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RW</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_DATA_ACCESS_RO</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_DENIED</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">check_FFA_mem_relinquish_resp_flags_for_share</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_resp_flag</span>: <span class="id" title="var">FFA_mem_relinquish_resp_flags_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">relinquish_resp_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">zero_memory_before_retrieval_flag_in_FFA_mem_relinquish_resp_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">None</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETER if it is not satisfied 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_mem_relinquish_resp_transaction_type_check</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">relinquish_resp_flag</span>: <span class="id" title="var">FFA_mem_relinquish_resp_flags_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">function_type</span> : <span class="id" title="var">option</span> <span class="id" title="var">FFA_FUNCTION_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">relinquish_resp_flag</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">memory_management_transaction_type_flag_in_FFA_mem_relinquish_resp_flags_struct</span>) <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_DEFAULT_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_SHARE_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_SHARE</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_LEND_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_LEND</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">MEMORY_MANAGEMENT_DONATE_TRANSACTION</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">FFA_MEM_DONATE</span> =&gt; <span class="id" title="var">None</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>        <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_mem_relinquish_resp_flags_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_mem_relinquish_resp_flags_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">MEMORY_MANAGEMENT_DEFAULT_TRANSACTION</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab80"></a><h4 class="section">FFA Mem Region Flags Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <span class="id" title="var">ffa_memory_region_flags_t</span> :=<br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_REGION_FLAG_DEFAULT</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_REGION_FLAG_NORMAL</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">flag</span>: <span class="id" title="var">FFA_mem_default_flags_struct</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_REGION_FLAG_RELINQUISH_REQ</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">flag</span>: <span class="id" title="var">FFA_mem_relinquish_req_flags_struct</span>)<br/>
&nbsp;&nbsp;| <span class="id" title="var">MEMORY_REGION_FLAG_RELINQUISH_RESP</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">flag</span>: <span class="id" title="var">FFA_mem_relinquish_resp_flags_struct</span>).<br/>

<br/>
</div>

<div class="doc">
The following descriptor specifies the data structure that must be used by the 
      Owner/Lender and a Borrower/Receiver in a transaction to donate, lend or share a memory region. 
      It specifies the memory region description (see 5.10 Memory region description), 
      properties (see 5.11 Memory region properties) and other transaction attributes in an
      invocation of the following ABIs.
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_DONATE</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_LEND</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_SHARE</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_REQ</span></span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">FFA_MEM_RETRIEVE_RESP</span></span>

</li>
</ul>

<div class="paragraph"> </div>

      The interpretation of some fields in Table 5.19 depends on the ABI this table is used with. This variance in
      behavior is also specified in Table 5.19.
   
<div class="paragraph"> </div>

<a name="lab81"></a><h2 class="section">Table 5.19: Lend, donate or share memory transaction descriptor</h2>
 Table 5.19: Lend, donate or share memory transaction descriptor  Note that it is also used for retrieve requests and responses. The ID of the VM which originally sent the memory region, i.e. the  owner.
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">ffa_vm_id_t</span></span> <span class="inlinecode"><span class="id" title="var">sender</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_attributes_t</span></span> <span class="inlinecode"><span class="id" title="var">attributes</span>;</span>: 5.11.4 Memory region attributes usage.

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint8_t</span></span> <span class="inlinecode"><span class="id" title="var">reserved_0</span>;</span>: Reserved field, must be 0. Flags to control behaviour of the transaction.

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_region_flags_t</span></span> <span class="inlinecode"><span class="id" title="var">flags</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_handle_t</span></span> <span class="inlinecode"><span class="id" title="var">handle</span>;</span>: An implementation defined value associated with the receiver and the memory region.

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint64_t</span></span> <span class="inlinecode"><span class="id" title="var">tag</span>;</span>: Reserved field, must be 0.

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">reserved_1</span>;</span>: The number of `ffa_memory_access` entries included in this transaction.

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">receiver_count</span>;</span>: An array of `attribute_count` endpoint memory access descriptors.
        Each one specifies a memory region offset, an endpoint and the
        attributes with which this memory region should be mapped in that
        endpoint's page table.

</li>
<li> <span class="inlinecode"><span class="id" title="keyword">struct</span></span> <span class="inlinecode"><span class="id" title="var">ffa_memory_access</span></span> <span class="inlinecode"><span class="id" title="var">receivers</span>[];</span>

</li>
</ul>
   
</div>
<div class="code">

<br/>
</div>

<div class="doc">
<a name="lab82"></a><h4 class="section">FFA Memory Region Coq Definition</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_memory_region_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_region_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 2 bytes / offset: 0 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_sender</span> : <span class="id" title="var">ffa_UUID_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 1 bytes / offset: 2 bytes 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_attributes</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_attributes_descriptor_struct</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 1 bytes / offset: 3 bytes (Reserved (MBZ)) 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_flags</span> : <span class="id" title="var">ffa_memory_region_flags_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">The</span></span> <span class="inlinecode"><span class="id" title="var">following</span></span> <span class="inlinecode"><span class="id" title="var">two</span></span> <span class="inlinecode"><span class="id" title="var">things</span></span> <span class="inlinecode"><span class="id" title="var">has</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">handled</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">specification</span></span> <ul class="doclist">
<li> length: 8 bytes / offset: 8 bytes

<div class="paragraph"> </div>

<ul class="doclist">
<li> length: 4 bytes / offset: 4 bytes

</li>
<li> This field must be zero (MBZ) in an invocation of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>
              A successful invocation of each of the preceding ABIs returns a Handle (see 5.10.2 Memory region handle)
              to identify the memory region in the transaction.

</li>
<li> The Sender must convey the Handle to the Receiver through a Partition message.

</li>
<li> This field must be used by the Receiver to encode this Handle in an invocation of the FFA_MEM_RETRIEVE_REQ
              ABI.

</li>
<li> A Relayer must validate this field in an invocation of the FFA_MEM_RETRIEVE_REQ ABI as follows.
              – Ensure that it holds a Handle value that was previously allocated and has not been reclaimed by the
                Owner.
              – Ensure that the Handle identifies a memory region that was shared, lent or donated to the Receiver.
              – Ensure that the Handle was allocated to the Owner specified in the Sender endpoint ID field of the
                transaction descriptor.
                It must return INVALID_PARAMETERS if the validation fails.

</li>
<li> This field must be used by the Relayer to encode the Handle in an invocation of the FFA_MEM_RETRIEVE_RESP
              ABI.

</li>
</ul>
         
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_handle</span> : <span class="id" title="var">ffa_memory_handle_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length : 8 bytes / offset 16 bytes

<div class="paragraph"> </div>

<ul class="doclist">
<li> This 64-bit field must be used to specify an IMPLEMENTATION DEFINED value associated with the transaction
              and known to participating endpoints.

</li>
<li> The Sender must specify this field to the Relayer in an invocation of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>

</li>
<li> The Sender must convey the Tag to the Receiver through a Partition message.

</li>
<li> This field must be used by the Receiver to encode the Tag in an invocation of the FFA_MEM_RETRIEVE_REQ
              ABI.

</li>
<li> The Relayer must ensure the Tag value specified by the Receiver is equal to the value that was specified by
              the Sender. It must return INVALID_PARAMETERS if the validation fails.

</li>
<li> This field must be used by the Relayer to encode the Tag value in an invocation of the FFA_MEM_RETRIEVE_RESP
              ABI.

</li>
</ul>
        
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_tag</span> : <span class="id" title="var">ffa_memory_region_tag_t</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 4 bytes / offset: 24 bytes (Reserved (MBZ))

<div class="paragraph"> </div>

<ul class="doclist">
<li> length: 4 bytes / offset: 28 bytes
<ul class="doclist">
<li> FFA_memory_region_struct_receiver_count : Z;

</li>
<li> we ignored this by representing receivers as a list

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> length: FFA_memory_region_struct_receiver_count * 16 bytes / offset: 32 bytes 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_receivers</span> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">list</span> <span class="id" title="var">FFA_endpoint_memory_access_descriptor_struct</span>;<br/>
<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> This one is not actually mentioned in the document, and it is stored in
              different locations. However, we included this one in the region descriptor 
              for simplification at this moment 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_struct_composite</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_composite_memory_region_struct</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_memory_region_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_region_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 <span class="id" title="var">init_FFA_memory_region_attributes_descriptor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">MEMORY_REGION_FLAG_DEFAULT</span> 0 <span class="id" title="var">init_ffa_memory_region_tag</span> <span class="id" title="var">nil</span> <span class="id" title="var">init_FFA_composite_memory_region_struct</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab83"></a><h4 class="section">well formed conditions</h4>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">well_formed_FFA_memory_region_struct_receivers</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">access_descriptors</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">list</span> <span class="id" title="var">FFA_endpoint_memory_access_descriptor_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">composite_descriptors</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_composite_memory_region_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">access_descriptors</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">nil</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">hd</span>::<span class="id" title="var">tl</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">well_formed_FFA_endpoint_memory_access_descriptor_struct</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">hd</span> <span class="id" title="var">composite_descriptors</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">well_formed_FFA_memory_region_struct_receivers</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">tl</span> <span class="id" title="var">composite_descriptors</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_memory_region_receivers_number_donate_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_memory_region</span>: <span class="id" title="var">FFA_memory_region_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> ((<span class="id" title="var">length</span> <span class="id" title="var">ffa_memory_region</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_memory_region_struct_receivers</span>) = 1)%<span class="id" title="var">nat</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">false</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">FFA_memory_region_receivers_number_lend_and_share_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">ffa_memory_region</span>: <span class="id" title="var">FFA_memory_region_struct</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> ((<span class="id" title="var">length</span> <span class="id" title="var">ffa_memory_region</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.(<span class="id" title="var">FFA_memory_region_struct_receivers</span>) &gt; 0)%<span class="id" title="var">nat</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">false</span>.<br/>

<br/>
</div>

<div class="doc">
Return INVALID_PARAMETERS when it is not satisfied <ul class="doclist">
<li> For Tag, the following thing is not captured in our well-formed conditions 
<ul class="doclist">
<li> The Relayer must ensure the Tag value specified by the Receiver is equal to the value that was specified by
          the Sender. It must return INVALID_PARAMETERS if the validation fails. 
</li>
</ul>

</li>
</ul>
<ul class="doclist">
<li> For offset, the following thing is not captured in our well-formed conditions (in terms of Receiver's view)
<ul class="doclist">
<li> The value 0 must be specified in the Offset field of the corresponding endpoint memory access descriptor in the
          array. This implies that the Handle specified in Table 5.19 must be used to identify the memory region (see 5.12.1
          Handle usage) 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">well_formed_FFA_memory_region_struct</span> (<span class="id" title="var">sender</span>: <span class="id" title="var">ffa_UUID_t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">memory_region</span> : <span class="id" title="var">FFA_memory_region_struct</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">function_type</span> : <span class="id" title="var">FFA_FUNCTION_TYPE</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">handle_value_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">memory_region</span>.(<span class="id" title="var">FFA_memory_region_struct_handle</span>) = 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">true</span> <span class="id" title="keyword">else</span> <span class="id" title="var">false</span> <span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">handle_value_and_receiver_num_check</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">function_type</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_DONATE</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_receivers_number_donate_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">memory_region</span> &amp;&amp; <span class="id" title="var">handle_value_check</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_LEND</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">FFA_MEM_SHARE</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_region_receivers_number_lend_and_share_check</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">memory_region</span> &amp;&amp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">handle_value_check</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">We</span></span> <span class="inlinecode"><span class="id" title="var">can</span></span> <span class="inlinecode"><span class="id" title="var">think</span></span> <span class="inlinecode"><span class="id" title="var">about</span></span> <span class="inlinecode"><span class="id" title="var">adding</span></span> <span class="inlinecode"><span class="id" title="var">more</span></span> <span class="inlinecode"><span class="id" title="var">constraints</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">here</span></span> 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> =&gt; <span class="id" title="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">handle_value_check</span> <span class="id" title="keyword">then</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="var">decide</span> (<span class="id" title="var">sender</span> = <span class="id" title="var">memory_region</span>.(<span class="id" title="var">FFA_memory_region_struct_sender</span>)) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="keyword">if</span> (<span class="id" title="var">well_formed_FFA_memory_region_struct_receivers</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">memory_region</span>.(<span class="id" title="var">FFA_memory_region_struct_receivers</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">memory_region</span>.(<span class="id" title="var">FFA_memory_region_struct_composite</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">None</span> <span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span>  <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">Some</span> (<span class="id" title="var">FFA_INVALID_PARAMETERS</span>).<br/>

<br/>

<br/>
</div>

<div class="doc">
<a name="lab84"></a><h2 class="section">Handle Usage</h2>

<div class="paragraph"> </div>

<ul class="doclist">
<li> This field must be zero (MBZ) in an invocation of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>

</li>
<li> A successful invocation of each of the preceding ABIs returns a Handle (see 5.10.2 Memory region handle)
        to identify the memory region in the transaction.

</li>
<li> The Sender must convey the Handle to the Receiver through a Partition message.

</li>
<li> This field must be used by the Receiver to encode this Handle in an invocation of the FFA_MEM_RETRIEVE_REQ
        ABI.

</li>
<li> A Relayer must validate this field in an invocation of the FFA_MEM_RETRIEVE_REQ ABI as follows.
<ul class="doclist">
<li> Ensure that it holds a Handle value that was previously allocated and has not been reclaimed by the
          Owner.

</li>
<li> Ensure that the Handle identifies a memory region that was shared, lent or donated to the Receiver.

</li>
<li> Ensure that the Handle was allocated to the Owner specified in the Sender endpoint ID field of the
          transaction descriptor.

</li>
</ul>
        It must return INVALID_PARAMETERS if the validation fails.

</li>
<li> This field must be used by the Relayer to encode the Handle in an invocation of the FFA_MEM_RETRIEVE_RESP
        ABI.

</li>
</ul>
   
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">See</span></span> <span class="inlinecode"><span class="id" title="var">well_formed_FFA_memory_region_struct</span></span> 
<div class="paragraph"> </div>

<a name="lab85"></a><h2 class="section">Tag usage</h2>

<div class="paragraph"> </div>

<ul class="doclist">
<li> This 64-bit field must be used to specify an IMPLEMENTATION DEFINED value associated with the transaction
       and known to participating endpoints.

</li>
<li> The Sender must specify this field to the Relayer in an invocation of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>

</li>
<li> The Sender must convey the Tag to the Receiver through a Partition message.

</li>
<li> This field must be used by the Receiver to encode the Tag in an invocation of the FFA_MEM_RETRIEVE_REQ
       ABI.

</li>
<li> The Relayer must ensure the Tag value specified by the Receiver is equal to the value that was specified by
       the Sender. It must return INVALID_PARAMETERS if the validation fails.

</li>
<li> This field must be used by the Relayer to encode the Tag value in an invocation of the FFA_MEM_RETRIEVE_RESP
       ABI. 

</li>
</ul>
   
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">See</span></span> <span class="inlinecode"><span class="id" title="var">well_formed_FFA_memory_region_struct</span></span> 
<div class="paragraph"> </div>

<a name="lab86"></a><h2 class="section">Endpoint memory access descriptor array usage</h2>
 <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">similar</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">previous</span></span> <span class="inlinecode"><span class="id" title="var">usage</span></span> <span class="inlinecode"><span class="id" title="var">descriptions</span>,</span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">following</span></span> 
      <span class="inlinecode"><span class="id" title="var">things</span></span> <span class="inlinecode"><span class="id" title="var">has</span></span> <span class="inlinecode"><span class="id" title="var">to</span></span> <span class="inlinecode"><span class="id" title="var">be</span></span> <span class="inlinecode"><span class="id" title="var">defined</span></span> <span class="inlinecode"><span class="id" title="keyword">as</span></span> <span class="inlinecode"><span class="id" title="var">invariants</span></span> <a name="lab87"></a><h3 class="section">Sender usage</h3>
 A Sender must use this field to specify one or more Receivers and the access permissions each should have on the
      memory region it is donating, lending or sharing through an invocation of one of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>

<div class="paragraph"> </div>

      The access permissions and flags are subject to validation at the virtual and physical FF-A instances as specified in
      5.11.3 Instruction access permissions usage, 5.11.2 Data access permissions usage and 5.11.1 ABI-specific flags
      usage.

<div class="paragraph"> </div>

      In a FFA_MEM_SHARE ABI invocation, the Sender could request the memory region to be mapped with different
      data access permission in its own translation regime. It must specify these permissions and its endpoint ID in a
      separate Endpoint memory access descriptor.

<div class="paragraph"> </div>

      A Sender must describe the memory region in a composite memory region descriptor (see Table 5.13) with the
      following non-exhaustive list of checks.
<ul class="doclist">
<li> Ensure that the address ranges specified in the composite memory region descriptor do not overlap each other.

</li>
<li> Total page count is equal to the sum of the Page count fields in each Constituent memory region descriptor.
        <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">It</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">already</span></span> <span class="inlinecode"><span class="id" title="var">checked</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> <span class="inlinecode"><span class="id" title="var">our</span></span> <span class="inlinecode"><span class="id" title="var">well</span>-<span class="id" title="var">formedness</span></span>

</li>
</ul>

<div class="paragraph"> </div>

      The offset to this descriptor from the base of Table 5.19 must be specified in the Offset field of the Endpoint
      memory access descriptor as follows.

<div class="paragraph"> </div>

<ul class="doclist">
<li> In a FFA_MEM_DONATE ABI invocation,
<ul class="doclist">
<li> The Endpoint memory access descriptor count field in the transaction descriptor must be set to 1. This
          implies that the Owner must specify a single Receiver endpoint in a transaction to donate memory.

</li>
<li> The Offset field of the Endpoint memory access descriptor must be set to the offset of the composite
          memory region descriptor

</li>
</ul>

</li>
<li> In a FFA_MEM_LEND and FFA_MEM_SHARE ABI invocation,
<ul class="doclist">
<li> The Endpoint memory access descriptor count field in the transaction descriptor must be set to a non-zero
          value. This implies that the Owner must specify at least a single Borrower endpoint in a transaction to
          lend or share memory.

</li>
<li> The Offset field in the Endpoint memory access descriptor of each Borrower must be set to the offset of
          the composite memory region descriptor. This implies that all values of the Offset field must be equal.

</li>
</ul>

</li>
</ul>
   
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">See</span></span> <span class="inlinecode"><span class="id" title="var">well_formed_FFA_memory_region_struct</span></span> 
<div class="paragraph"> </div>

<a name="lab88"></a><h3 class="section">Receiver usage</h3>
 A Receiver must use this field to specify the access permissions it should have on the memory region
      being donated,
      lent or shared in an invocation of the FFA_MEM_RETRIEVE_REQ ABI. This is specified in 5.11.3 Instruction
      access permissions usage and 5.11.2 Data access permissions usage.
<ul class="doclist">
<li> A Receiver could do this on its behalf if it is a PE endpoint.

</li>
<li> A Receiver could do this on the behalf of its dependent peripheral devices if it is a proxy endpoint.

</li>
</ul>

<div class="paragraph"> </div>

      A Receiver could specify the address ranges that must be used to map the memory region in its translation regime
      by describing them in a composite memory region descriptor. The Receiver must perform the same checks as a
      Sender. These checks are described in 5.12.3.1 Sender usage.

<div class="paragraph"> </div>

      The offset to this descriptor from the base of Table 5.19 must be specified in the Offset field of the corresponding
      endpoint memory access descriptor in the array. This implies that all values of the Offset field could be different
      from each other.

<div class="paragraph"> </div>

      A Receiver could let the Relayer allocate the address ranges that must be used to map the memory region in its
      translation regime and optionally provide an alignment hint (see Address range alignment hint in Table 5.21).

<div class="paragraph"> </div>

      The value 0 must be specified in the Offset field of the corresponding endpoint memory access descriptor in the
      array. This implies that the Handle specified in Table 5.19 must be used to identify the memory region (see 5.12.1
      Handle usage).
      A memory management transaction could be to lend or share memory with multiple Borrowers. The Receiver
      must use this field to specify:
<ul class="doclist">
<li> The SEPIDs and data access permissions of any dependent peripheral devices (if any) that the Receiver is a
        proxy endpoint for. 
        If the Relayer must allocate the address ranges to map the memory region in the Stream endpoints, the value
        0 must be specified in the Offset field of the corresponding endpoint memory access descriptor in the array.
        If the Receiver specifies the address ranges to map the memory region in the Stream endpoints, then it must
        follow the preceding guidance to specify the address ranges that must be used to map the memory region in
        its translation regime.

</li>
<li> The identity of any other Borrowers and their data access permissions on the memory region (see 5.11.2
        Data access permissions usage and 5.11.1 ABI-specific flags usage).
        The value 0 must be specified in the Offset field of the corresponding endpoint memory access descriptor in
        the array.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab89"></a><h3 class="section">Relayer usage</h3>
 A Relayer must validate the Endpoint memory access descriptor count and each entry in the Endpoint memory
      access descriptor array as follows.
<ul class="doclist">
<li> The Relayer could support memory management transactions targeted to only a single Receiver endpoint.
        It must return INVALID_PARAMETERS if the Sender or Receiver specifies an Endpoint memory access
        descriptor count != 1.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">This</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">captured</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">our</span></span> <span class="inlinecode"><span class="id" title="var">well</span></span> <span class="inlinecode"><span class="id" title="var">formed</span></span> <span class="inlinecode"><span class="id" title="var">condition</span></span>

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> It must ensure that these fields have been populated by the Sender as specified in 5.12.3.1 Sender usage in an
        invocation of any of the following ABIs.
<ul class="doclist">
<li> FFA_MEM_DONATE.

</li>
<li> FFA_MEM_LEND.

</li>
<li> FFA_MEM_SHARE.

</li>
</ul>
        The Relayer must return INVALID_PARAMETERS in case of an error.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">This</span></span> <span class="inlinecode"><span class="id" title="var">one</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">captured</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">our</span></span> <span class="inlinecode"><span class="id" title="var">well</span></span> <span class="inlinecode"><span class="id" title="var">formed</span></span> <span class="inlinecode"><span class="id" title="var">condition</span></span>

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> It must ensure that the Endpoint ID field in each Memory access permissions descriptor specifies a valid
        endpoint. The Relayer must return INVALID_PARAMETERS in case of an error.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">JIEUNG</span>:</span> <span class="inlinecode"><span class="id" title="var">Additional</span></span> <span class="inlinecode"><span class="id" title="var">checks</span></span> <span class="inlinecode"><span class="id" title="var">required</span></span> <span class="inlinecode">-</span> <span class="inlinecode"><span class="id" title="var">it</span></span> <span class="inlinecode"><span class="id" title="keyword">is</span></span> <span class="inlinecode"><span class="id" title="var">maybe</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">the</span></span> <span class="inlinecode"><span class="id" title="var">argument</span></span> <span class="inlinecode"><span class="id" title="var">checks</span>...</span> <span class="inlinecode"><span class="id" title="var">not</span></span> <span class="inlinecode"><span class="id" title="tactic">in</span></span> <span class="inlinecode"><span class="id" title="var">here</span></span>

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> In an invocation of the FFA_MEM_RETRIEVE_REQ ABI,
<ul class="doclist">
<li> It must ensure that these fields have been populated by the Receiver as specified in 5.12.3.2 Receiver
          usage.

</li>
<li> If the memory region has been lent or shared with multiple Borrowers, the Relayer must ensure that the
          identity of each Borrower specified by the Receiver is the same as that specified by the Sender.

</li>
<li> If one or more Borrowers are dependent peripheral devices, the Relayer must ensure that the Receiver is
          their proxy endpoint.

</li>
<li> If the Receiver specifies the address ranges that must be used to map the memory region in its translation
          regime, the Relayer must ensure that the size of the memory region is equal to that specified by the
          Sender.

</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

      The Relayer must return INVALID_PARAMETERS in case of an error.

<div class="paragraph"> </div>

<ul class="doclist">
<li> It must validate the access permissions in the Memory access permissions descriptor in each Endpoint
        memory access descriptor as specified in 5.11.2 Data access permissions usage and 5.11.3 Instruction
        access permissions usage.

</li>
</ul>

<div class="paragraph"> </div>

      A Relayer must use this field in an invocation of the FFA_MEM_RETRIEVE_RESP ABI in response to successful
      validation of a FFA_MEM_RETRIEVE_REQ ABI invocation as follows.
<ul class="doclist">
<li> To specify the access permissions with which the memory region has been mapped in the translation regime
        of the Receiver.

</li>
<li> A Receiver could let the Relayer allocate the address ranges to map the memory region. In this case, the
        Relayer must describe the address ranges in a composite memory region descriptor. The Relayer must
        perform the same checks as a Sender. These checks are described in 5.12.3.1 Sender usage.
        The offset to this descriptor from the base of Table 5.19 must be specified in the Offset field of the
        corresponding endpoint memory access descriptor in the array. This implies that all values of the Offset field
        could be different from each other.

</li>
<li> A Receiver could specify the address ranges that must be used to map the memory region in its translation
        regime. The Relayer must specify the value 0 in the Offset field of the corresponding endpoint memory
        access descriptor in the array.

</li>
</ul>
   
<div class="paragraph"> </div>

<a name="lab90"></a><h2 class="section">Table 11.25: Descriptor to relinquish a memory region</h2>

<div class="paragraph"> </div>

 For Relinquish, One more additional tables are defined in Section 11.  Table 11.25: Descriptor to relinquish a memory region
<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_handle_t</span></span> <span class="inlinecode"><span class="id" title="var">handle</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_memory_region_flags_t</span></span> <span class="inlinecode"><span class="id" title="var">flags</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">uint32_t</span></span> <span class="inlinecode"><span class="id" title="var">endpoint_count</span>;</span>

</li>
<li> <span class="inlinecode"><span class="id" title="var">ffa_vm_id_t</span></span> <span class="inlinecode">*</span> <span class="inlinecode"><span class="id" title="var">endpoints</span>;</span>

</li>
</ul>
   
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Record</span> <span class="id" title="var">FFA_memory_relinquish_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_relinquish_struct</span> {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 8 bytes / offset: 0 bytes 
<ul class="doclist">
<li> Globally unique Handle to identify a memory region. 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_relinquish_struct_handle</span> : <span class="id" title="var">ffa_memory_handle_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 3 bytes / offset: 8 bytes

<div class="paragraph"> </div>

<ul class="doclist">
<li> Bit(0): Zero memory after relinquish flag.
<ul class="doclist">
<li> This flag specifies if the Relayer must clear memory region contents after unmapping it
                from from the translation regime of the Borrower.
<ul class="doclist">
<li> b0: Relayer must not zero the memory region contents.

</li>
<li> b1: Relayer must zero the memory region contents.

</li>
</ul>

</li>
<li> If the memory region was lent to multiple Borrowers, the Relayer must clear memory
                region contents after unmapping it from the translation regime of each Borrower, if any
                Borrower including the caller sets this flag.

</li>
<li> MBZ if the memory region was shared, else the Relayer must return INVALID_PARAMETERS.

</li>
<li> MBZ if the Borrower has Read-only access to the memory region, else the Relayer must return DENIED.

</li>
<li> Relayer must fulfill memory zeroing requirements listed in 5.12.4 Flags usage.

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> Bit(1): Operation time slicing flag.
              – This flag specifies if the Relayer can time slice this operation.
<ul class="doclist">
<li> b0: Relayer must not time slice this operation.

</li>
<li> b1: Relayer can time slice this operation.

</li>
</ul>

</li>
</ul>

</li>
<li> MBZ if the Relayer does not support time slicing of memory management operations
                (see 12.2.3 Time slicing of memory management operations). 

<div class="paragraph"> </div>


</li>
<li> Bit(31:2): Reserved (MBZ). 
</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_relinquish_struct_flags</span> : <span class="id" title="var">ffa_memory_region_flags_t</span>;<br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div>

<div class="doc">
<ul class="doclist">
<li> length: 4 bytes / offset: 12 bytes
<ul class="doclist">
<li> Count of endpoints. 

</li>
<li> we ignored this one by representing endpoints as a list

</li>
<li> FFA_mem_relinquish_struct_endpoint_count : Z; 

<div class="paragraph"> </div>


</li>
</ul>

</li>
<li> length: FFA_mem_relinquish_struct_endpoint_count * 2 bytes / offset: 16 bytes
<ul class="doclist">
<li> Array of endpoint IDs. Each entry contains a 16-bit ID. 
</li>
</ul>

</li>
</ul>

</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">FFA_memory_relinquish_struct_endpoints</span> : <span class="id" title="var">list</span> <span class="id" title="var">ffa_UUID_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">init_FFA_mem_relinquish_struct</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkFFA_memory_relinquish_struct</span> 0 <span class="id" title="var">MEMORY_REGION_FLAG_DEFAULT</span> <span class="id" title="var">nil</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab91"></a><h4 class="section">well formed</h4>
 for FFA_memory_relinquish_struct_flags,
      we can check flag values using the previous well-formed checks  for FFA_memory_relinquish_struct_endpoints,
      we need to check whether all endpoints are valid 
</div>
<div class="code">

<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_MEMORY_REGION_DESCRIPTOR</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab92"></a><h1 class="section">Descriptor Context</h1>
 This context defines the abstract view of 
    the handle and relative auxiliary functions with the handle. 
</div>
<div class="code">
<span class="id" title="keyword">Section</span> <span class="id" title="var">FFA_MEMORY_REGION_DESCRIPTOR_CONTEXT</span>.<br/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Class</span> <span class="id" title="var">DescriptorContext</span> `{<span class="id" title="var">ffa_types_and_constants</span>: <span class="id" title="var">FFA_TYPES_AND_CONSTANTS</span>} :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">make_handle</span> (<span class="id" title="var">vid</span>: <span class="id" title="var">ffa_UUID_t</span>) (<span class="id" title="var">value</span>: <span class="id" title="var">Z</span>) : <span class="id" title="var">option</span> <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get_value</span> (<span class="id" title="var">handle</span>: <span class="id" title="var">Z</span>) : <span class="id" title="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">get_sender</span> (<span class="id" title="var">handle</span>: <span class="id" title="var">Z</span>) : <span class="id" title="var">ffa_UUID_t</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}.<br/>

<br/>
<span class="id" title="keyword">End</span> <span class="id" title="var">FFA_MEMORY_REGION_DESCRIPTOR_CONTEXT</span>.<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="index.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>